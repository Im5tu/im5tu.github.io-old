<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Stuart Blackler"><meta name=description content="In a previous article, we took a look at a way to use dotnet-counters with an external image. This article takes a look at how we can embed the tooling that we require into the image so that we extract the counter/memory information as required. This approach does not require elevated permissions as before."><meta name=keywords content=",aspnetcore,dotnet,diagnostics"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-an-alternative-approach-to-using-dotnet-counters-with-docker/><title>Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker :: Stuart Blackler's Blog</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.dede02da9537a98158079c023e83573e18127834838ef08172acce888341a797.css><meta itemprop=name content="Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker"><meta itemprop=description content="A look into the EventCounters API in .Net Core 3, and seeing how we can capture inbound HTTP Requests."><meta itemprop=datePublished content="2020-06-25T22:56:00+01:00"><meta itemprop=dateModified content="2020-06-25T22:56:00+01:00"><meta itemprop=wordCount content="688"><meta itemprop=keywords content="aspnetcore,dotnet,diagnostics,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker"><meta name=twitter:description content="A look into the EventCounters API in .Net Core 3, and seeing how we can capture inbound HTTP Requests."><meta property="og:title" content="Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker"><meta property="og:description" content="A look into the EventCounters API in .Net Core 3, and seeing how we can capture inbound HTTP Requests."><meta property="og:type" content="article"><meta property="og:url" content="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-an-alternative-approach-to-using-dotnet-counters-with-docker/"><meta property="article:published_time" content="2020-06-25T22:56:00+01:00"><meta property="article:modified_time" content="2020-06-25T22:56:00+01:00"><meta property="article:section" content="aspnetcore"><meta property="article:section" content="dotnet"><meta property="article:section" content="diagnostics"><meta property="article:published_time" content="2020-06-25 22:56:00 +0100 BST"><link rel=alternate type=application/rss+xml href=https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-an-alternative-approach-to-using-dotnet-counters-with-docker/index.xml title="Stuart Blackler's Blog"><meta property="og:image" content="https://im5tu.io/img/profile.jpg"><meta property="og:site_name" content="Stuart Blackler's Blog"><link rel=alternate type=application/rss+xml href=/index.xml title="Stuart Blackler's Blog"><link rel=preconnect href=https://api.github.com><link rel=preconnect href=https://partner.googleadservices.com><link rel=preconnect href=https://tpc.googlesyndication.com><link rel=preconnect href=https://www.googletagservices.com><link rel=preconnect href=https://googleads.g.doubleclick.net><link rel=preconnect href=https://pagead2.googlesyndication.com><link rel=preload href=/fonts/Inter-UI-Bold.woff2><link rel=preload href=/fonts/Inter-UI-Regular.woff2><style>.post{max-width:1200px}.header__inner{width:100%;max-width:1160px}.copy-code-button{float:right;display:block;padding:8px 12px;font-size:.9em;background-color:#e2e2e2;border-left:1px solid #e2e2e2;border-bottom:1px solid #e2e2e2;border-radius:0;border-bottom-left-radius:10px;transition:all 250ms ease;margin:-18px;opacity:0}.copy-code-button:hover{cursor:pointer;opacity:.7;border-style:solid}.copy-code-button:focus{background-color:#e2e2e2;outline:0;border-style:solid}.copy-code-button:active{background-color:#e2e2e2;opacity:.5;border-style:solid}pre:hover .copy-code-button{opacity:1}.copy-code-button~pre{position:relative}table{width:100%;border-collapse:collapse}table th{background-color:#cecece;color:#222}table tr{margin:0;padding:0}table tr:first-child{border-left:1px solid #acacac;border-top:1px solid #acacac;border-right:1px solid #acacac}table tr td:first-child{border-left:1px solid #acacac}table tr td:last-child{border-right:1px solid #acacac}table td,table th{padding:.5em;border-bottom:1px solid #acacac;margin:0}h2 a:link,h2 a:visited,h3 a:link,h3 a:visited,h4 a:link,h4 a:visited,h5 a:link,h5 a:visited{text-decoration:none}h2 a:hover,h3 a:hover,h4 a:hover,h5 a:hover{text-decoration:underline}@media print{.copy-code-button{display:none}}@media(prefers-color-scheme:dark){.copy-code-button{background-color:#969696;color:#323232}}</style><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-88036425-1','auto');ga('send','pageview');</script><script data-ad-client=ca-pub-8597760177900459 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=https://im5tu.io/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>im5tu.io</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://im5tu.io/article/>Articles</a></li><li><a href=https://im5tu.io/index.xml>RSS Feed</a></li><li><a href=https://twitter.com/im5tu>Twitter</a></li><li><a href=https://www.youtube.com/channel/UCF5dh7bm49bpsZjWHYDG4Lg>YouTube</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 minutes</p></div><article><h1 class=post-title><a href=https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-an-alternative-approach-to-using-dotnet-counters-with-docker/>Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker</a></h1><div class=post-content><section class="series series-header"><p><i>This article is part of the <a href=#series>Diagnostics in .Net Core 3</a> series. You are reading part 5 of 5.</i></p></section><p>In a <a href=/article/2020/01/diagnostics-in-.net-core-3-using-dotnet-counters-with-docker/>previous article</a>, we took a look at a way to use <code>dotnet-counters</code> with an external image. This article takes a look at how we can embed the tooling that we require into the image so that we extract the counter/memory information as required. This approach does not require elevated permissions as before.</p><p>Let&rsquo;s assume that we are starting with the following dockerfile:</p><pre><code class=language-dockerfile># Publish the application using the SDK
FROM mcr.microsoft.com/dotnet/core/sdk:3.1-alpine AS build
WORKDIR /app
RUN dotnet new webapp -n BlogApp
RUN dotnet publish /app/BlogApp/BlogApp.csproj -c Release -o /out /p:GenerateDocumentationFile=false

# Build the smaller runtime image
FROM mcr.microsoft.com/dotnet/core/aspnet:3.1-alpine
WORKDIR /app
COPY --from=build /out ./
EXPOSE 5000
ENTRYPOINT [&quot;dotnet&quot;, &quot;BlogApp.dll&quot;]
</code></pre><p>Here we use a docker multi-stage build to publish our application (which is also created inline for the purposes of this article). Once the code has been published, we can then make the a runtime image which has a lot less dependencies, thus a smaller image size, to host the published version of the application.</p><p><strong>Note:</strong> <em>If you don&rsquo;t use the same OS, like Alpine, on both steps, then you should specify the <code>-r</code> flag with the runtime identifier for the runtime image.</em></p><h2 id=installing-the-net-tools>Installing the .Net tools</h2><p>In order to embed the tooling inside of the runtime image, we first need to adapt our build image:</p><pre><code class=language-dockerfile># Publish the application using the SDK
FROM mcr.microsoft.com/dotnet/core/sdk:3.1-alpine AS build
WORKDIR /app
RUN dotnet new webapp -n BlogApp
RUN dotnet publish /app/BlogApp/BlogApp.csproj -c Release -o /out /p:GenerateDocumentationFile=false
# NEW CODE
RUN dotnet tool install dotnet-dump --tool-path /tools
RUN dotnet tool install dotnet-counters --tool-path /tools
RUN dotnet tool install dotnet-trace --tool-path /tools
# END OF NEW CODE
</code></pre><p>Here we leverage the dotnet tools ability to restore tooling to a specific directory, in this case <code>/tools</code>. Once the tools have been installed, we can copy them into the runtime image:</p><pre><code class=language-dockerfile># Build the smaller runtime image
FROM mcr.microsoft.com/dotnet/core/aspnet:3.1-alpine
WORKDIR /app
COPY --from=build /out ./
EXPOSE 5000
# NEW CODE
COPY --from=build /tools /tools
ENV PATH=&quot;/tools:${PATH}&quot;
# END OF NEW CODE
ENTRYPOINT [&quot;dotnet&quot;, &quot;BlogApp.dll&quot;]
</code></pre><h2 id=accessing-the-tools-at-runtime>Accessing the tools at runtime</h2><p>In order to access these tools at runtime, we need to be able to access the container at runtime. An example of this is being able to SSH into the running EC2 instance on AWS. Assuming that we have access, we can run the following command to get the running containers:</p><pre><code class=language-bash>docker ps
</code></pre><p>Which results in output similar to the following:</p><pre><code class=language-bash>CONTAINER ID  IMAGE             COMMAND                  CREATED        STATUS                    PORTS                NAMES
fac2377f3e87  myContainerImage  &quot;./usr/src/app/init.…&quot;   30 hours ago   Up 55 seconds (healthy)   0.0.0.0:80-&gt;80/tcp   myContainerImage
</code></pre><p>From here, we can use the <a href=https://docs.docker.com/engine/reference/commandline/exec/>docker exec</a> command to launch a shell in the new container, using the container ID from above:</p><pre><code class=language-bash>docker exec -it -w /tools &lt;ID&gt; /bin/sh
#Example:
docker exec -it -w /tools fac2377f3e87 /bin/sh
</code></pre><p><code>-it</code> tells docker that we want the shell to be interactive and to keep the shell open for us even when there is no immediate input, ie: we can type into it and get a response. <code>-w</code> means start in the working directory <code>/tools</code>. Next, replace <code>&lt;ID></code> with the container ID from the selection above. Finally, we pass in the command that we want to execute in the shell - which we open a shell so that we can run different commands.</p><p>Now you should be able to run <code>dotnet-counters</code>, <code>dotnet-dump</code> & <code>dotnet-trace</code> as normal. If you need to copy any files from the container then you need to run the following from the host machine:</p><pre><code class=language-bash>docker cp &lt;ID&gt;:&lt;path-to-file-in-container&gt; &lt;copy-to-path-on-host&gt;
#Example:
docker cp fac2377f3e87:/tools/output/trace.nettrace ./output/trace.nettrace
</code></pre><p>The <a href=https://docs.docker.com/engine/reference/commandline/cp/>docker cp</a> command allows us to copy a file from/to the running container (specified by <code>&lt;ID></code>). The only other thing that you need is the path of the file that you wish to copy from the container, and the destination path on the host machine.</p><p>Now you&rsquo;ll have the diagnostic tools embedded within your runtime images, at the correct version. Naturally, the more tools that you install, the larger the final size of the image will be. It does also take a little bit of prep work, but this can pay off massively for unexpected memory/cpu issues. Happy diagnosing.</p></div></article><hr><div class=post-info><a name=series></a><b>More in the Diagnostics in .Net Core 3 series:</b><ol><li><a href=/article/2020/01/diagnostics-in-.net-core-3-event-counters/>Diagnostics in .Net Core 3: Event Counters</a></li><li><a href=/article/2020/01/diagnostics-in-.net-core-3-using-dotnet-counters-with-docker/>Diagnostics in .Net Core 3: Using dotnet-counters with Docker</a></li><li><a href=/article/2020/06/diagnostics-in-.net-core-3-listening-to-outbound-http-requests/>Diagnostics in .Net Core 3: Listening to outbound HTTP requests</a></li><li><a href=/article/2020/06/diagnostics-in-.net-core-3-listening-to-inbound-http-requests/>Diagnostics in .Net Core 3: Listening to inbound HTTP requests</a></li><li>Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker <i>(This article)</i></li></ol><p><a href=/article>View All Articles</a></p><hr><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://im5tu.io/tags/aspnetcore>aspnetcore</a></span><span class=tag><a href=https://im5tu.io/tags/dotnet>dotnet</a></span><span class=tag><a href=https://im5tu.io/tags/diagnostics>diagnostics</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>688 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020-06-25 22:56 +0100</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://im5tu.io/article/2020/07/my-favourite-git-aliases/><span class=button__icon>←</span>
<span class=button__text>My Favourite Git Aliases</span></a></span>
<span class="button next"><a href=https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-listening-to-inbound-http-requests/><span class=button__text>Diagnostics in .Net Core 3: Listening to inbound HTTP requests</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=Im5tu/im5tu-hugo issue-term=url label=Comment theme=photon-dark crossorigin=anonymous async></script></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2020</span>
<span><a href=https://im5tu.io/>Stuart Blackler</a></span>
<span><a href=https://im5tu.io/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Theme made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=/bundle.min.dc716e9092c9820b77f96da294d0120aeeb189b5bcea9752309ebea27fd53bbe6b13cffb2aca8ecf32525647ceb7001f76091de4199ac5a3caa432c070247f5b.js integrity="sha512-3HFukJLJggt3+W2ilNASCu6xibW86pdSMJ6+on/VO75rE8/7KsqOzzJSVkfOtwAfdgkd5BmaxaPKpDLAcCR/Ww=="></script><script src=/js/site-20c12b24.js defer></script></body></html>