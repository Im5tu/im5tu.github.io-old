<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>How your binary search implementation is broken and how to fix it - Stuart Blackler&#39;s Blog</title>
    <link rel="canonical" href="https://im5tu.io/article/2014/06/how-your-binary-search-implementation-is-broken-and-how-to-fix-it/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="description" content="This post describes how a bug exists in most implementations of a binary search algorithm and how to fix it">
    
    
    <meta property="og:title" content="How your binary search implementation is broken and how to fix it - Stuart Blackler&#39;s Blog" />
<meta property="og:type" content="website" />

<meta property="og:description" content="This post describes how a bug exists in most implementations of a binary search algorithm and how to fix it">

<meta property="og:url" content="https://im5tu.io/article/2014/06/how-your-binary-search-implementation-is-broken-and-how-to-fix-it/" />
<meta property="og:image" content="https://im5tu.io/img/profile.jpg" />
<meta property="og:site_name" content="Stuart Blackler&#39;s Blog" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@im5tu" />

<style>body,html{height:100%;color:#303030;font-family:"Noto Sans","Helvetica Neue",Helvetica,Arial,sans-serif;font-display:auto;line-height:1.8em}h1,h2,h3,h4,h5,h6{font-family:Comfortaa,"Helvetica Neue",Helvetica,Arial,sans-serif;font-display:auto}p{margin:1.5em 0}blockquote{border-left:5px solid #454545;background-color:#fafafa;padding:.5em 1.5em}blockquote,blockquote p{color:#494949}blockquote~blockquote{margin-top:0;margin-bottom:0}.pageContainer{text-align:justify}.pageWrap{margin:0 auto;max-width:1400px}@media screen and (min-width:320px){.pageWrap{width:97%}}@media screen and (min-width:740px){.pageWrap{width:90%}}@media screen and (min-width:980px){.pageWrap{width:80%}}.pageWrap:after{content:"";display:table;clear:both}a{font-family:Comfortaa,"Helvetica Neue",Helvetica,Arial,sans-serif;font-display:auto}a:link,a:visited{color:#149fd1}a:link{text-decoration:none}a:hover{color:#2db9eb;text-decoration:underline}#pageHeader-about{border-bottom:1px solid #eaeaea}#pageHeader-about-title a{font-size:1.2em}#pageHeader-about-title a:link,#pageHeader-about-title a:visited{color:#232323}#pageHeader-about-title a:first-child{font-size:1.1em;color:#149fd1;text-transform:none}.article-list a{color:#0a0a0a}.article-list a:hover{color:#2db9eb;text-decoration:underline}.article-content li code,.article-content p code{color:#149fd1;background-color:rgba(27,31,35,.05)}.article-content li code:hover,.article-content p code:hover{opacity:.5}.article img{max-width:100%}ul.article-tags{display:inline;padding:0}ul.article-tags li{display:inline;padding:0 1em}ul.article-tags li a:link{text-decoration:underline}table{width:100%}table *{padding:0;margin:0}table th{display:-webkit-box;display:flex;width:100%;background:#000;color:#fff;padding:1em}table tr{display:-webkit-box;display:flex;width:100%}table tr:hover{opacity:.7}table tr:first-child{padding:0}table tr:nth-of-type(odd){background:#eee}table td{-webkit-box-flex:1;flex:1 1 20%;text-align:left;padding:1em}pre{line-height:1.4em}code{font-size:1.2em}@media (prefers-color-scheme:dark){body,html{color:#eaeaea;background:#323232}h1,h2,h3,h4,h5,h6{color:#fefefe}a:link,a:visited{color:#149fd1}.article-list h1 a:link,.article-list h1 a:visited,.article-list h2 a:link,.article-list h2 a:visited,.article-list h3 a:link,.article-list h3 a:visited,.article-list h4 a:link,.article-list h4 a:visited,.article-list h5 a:link,.article-list h5 a:visited,.article-list h6 a:link,.article-list h6 a:visited{color:#fefefe}#pageHeader-about-title a:link,#pageHeader-about-title a:visited{color:#dedede}#pageHeader-about-title a:first-child{color:#149fd1}table tr:nth-of-type(odd){background:#767676}pre,pre code{background:#dcdcdc!important;color:#323232}}.copy-code-button{float:right;display:block;padding:8px 12px;font-size:.9em;background-color:#e2e2e2;border:1px solid #e2e2e2;border-radius:0 0 10px 10px;-webkit-transition:all 250ms ease;transition:all 250ms ease;opacity:0}.copy-code-button:hover{cursor:pointer;opacity:.7;border-style:solid}.copy-code-button:focus{background-color:#e2e2e2;outline:0;border-style:solid}.copy-code-button:active{background-color:#e2e2e2;opacity:.5;border-style:solid}pre:hover .copy-code-button{opacity:1}.copy-code-button~pre{position:relative}@media print{.copy-code-button{display:none}}@media (prefers-color-scheme:dark){.copy-code-button{background-color:#969696;color:#323232}}</style>
<link href="https://fonts.googleapis.com/css?family=Comfortaa|Noto+Sans&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/tomorrow.min.css" rel="stylesheet"><link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Stuart Blackler&#39;s Blog" /></head>
<body>
<section class="pageContainer">
    <header id="pageHeader">
    <section id="pageHeader-about" class="pageWrap" itemscope itemtype="http://schema.org/person">
        <section id="pageHeader-about-title">
            <h1 itemprop="name"><a href="/" title="Stuart Blackler">@im5tu</a> / <a href="https://im5tu.io/article/2014/06/how-your-binary-search-implementation-is-broken-and-how-to-fix-it/">How your binary search implementation is broken and how to fix it</a></h1>
        </section>
    </section>
</header>
    <section class="pageContainer-content pageWrap">
        <article class="article" itemscope itemtype="http://schema.org/blog">
    <section class="article-content" itemprop="text"><p>I have recently begun studying the theory and implementations of algorithms. During this study, I came across <a href="http://googleresearch.blogspot.co.uk/2006/06/extra-extra-read-all-about-it-nearly.html">this post</a> which describes how a bug exists in most implementations of a binary search algorithm.</p>
<p>I'll begin with the example given in the post, which is taken from <code>java.util.Arrays</code>.</p>
<pre><code class="language-csharp">public static int BinarySearch(int[] a, int key) {
    int low = 0;
    int high = a.length - 1;
    while (low &lt;= high) {
        int mid = (low + high) / 2;
        int midVal = a[mid];
        if (midVal &lt; key)
        {
            low = mid + 1;
        }
        else if (midVal &gt; key)
        {
            high = mid - 1;
        }
        else
        {
            return mid; // key found
        }
    }
    return -(low + 1);  // key not found.
}
</code></pre>
<p>For all intensive purposes this implementation is correct. Except for a bug which can raise an Overflow Exception. The problematic line is this:</p>
<pre><code class="language-csharp">int mid = (low + high) / 2;
</code></pre>
<p>If the result of <code>low + high</code> is greater than maximum value of an 32-bit integer, the exception is raised. Luckily, there are ways that we can fix this:</p>
<pre><code class="language-csharp">int mid = low + (high - low) / 2;
</code></pre>
<p>Or if you're in Java:</p>
<pre><code class="language-csharp">int mid = (low + high) &gt;&gt;&gt; 1;
</code></pre>
<p>If you are working in .Net languages you will need to work with the <code>unchecked</code> keyword in order to use the bit shift method:</p>
<pre><code class="language-csharp">int mid;
unchecked
{
    mid = (low + high) &gt;&gt; 1;
}
</code></pre>
<blockquote>
<p>The <code>unchecked</code> keyword is used to suppress overflow-checking for integral-type arithmetic operations and conversions.</p>
<p>In an unchecked context, if an expression produces a value that is outside the range of the destination type, the overflow is not flagged. For example, because the calculation in the following example is performed in an unchecked block or expression, the fact that the result is too large for an integer is ignored, and int1 is assigned the value -2,147,483,639.</p>
</blockquote>
<p>(<a href="http://msdn.microsoft.com/en-GB/library/a569z7k8.aspx">Source</a>)</p>
<p>So here is the differential method in C#:</p>
<pre><code class="language-csharp">public static int BinarySearch(int[] a, int key) {
    int low = 0;
    int high = a.length - 1;
    while (low &lt;= high) {
        int mid = low + (high - low) / 2;
        int midVal = a[mid];
        if (midVal &lt; key)
        {
            low = mid + 1;
        }
        else if (midVal &gt; key)
        {
            high = mid - 1;
        }
        else
        {
            return mid; // key found
        }
    }
    return -1;  // key not found.
}
</code></pre>
<p>And using the bit shift method:</p>
<pre><code class="language-csharp">public static int BinarySearch(int[] a, int key) {
    int low = 0;
    int high = a.length - 1;
    while (low &lt;= high) {
        int mid;
        unchecked
        {
            mid = (low + high) &gt;&gt; 1;
        }
        int midVal = a[mid];
        if (midVal &lt; key)
        {
            low = mid + 1;
        }
        else if (midVal &gt; key)
        {
            high = mid - 1;
        }
        else
        {
            return mid; // key found
        }
    }
    return -1;  // key not found.
}
</code></pre>
<p>Personally, I prefer the differential version over the bit shift version but I have provided both for completeness. Even though this bug only manifests itself with well over a billion elements in an array, I still thought it was worth pointing out. I encourage you to read the other articles for more complete context.</p></section>
    <footer class="article-footer">
        <hr />
Tags: <ul class="article-tags">
    <li><a class="article-tag" href="/tags/csharp/">csharp</a></li><li><a class="article-tag" href="/tags/dotnet/">dotnet</a></li><li><a class="article-tag" href="/tags/java/">java</a></li>
</ul>
</footer>
</article>
    </section>
    <footer id="pageFooter" class="pageWrap">
    <p>&copy; 2020 <span itemprop="author">Stuart Blackler</span>. Last Updated: <time itemprop="datecreated" class="article-header-time" pubdate="pubdate" datetime="2014-06-20T18:21:04">2014-06-20 18:21:04 &#43;0000 UTC</time>. <a id="pageFooter-scroll-link" href="#">Scroll To Top</a>.</p>
</footer>
</section>
<script src="/js/site-54e01995.js" defer></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-88036425-1', 'auto');
  ga('send', 'pageview');
</script>


<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>