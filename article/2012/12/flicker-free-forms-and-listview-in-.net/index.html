<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Flicker free forms and listview in .Net - Stuart Blackler&#39;s Blog</title>
    <link rel="canonical" href="https://im5tu.io/article/2012/12/flicker-free-forms-and-listview-in-.net/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="description" content="Just one solution to a flicker problem I encountered when developing a windows form application.">
    
    
    <meta property="og:title" content="Flicker free forms and listview in .Net - Stuart Blackler&#39;s Blog" />
<meta property="og:type" content="website" />

<meta property="og:description" content="Just one solution to a flicker problem I encountered when developing a windows form application.">

<meta property="og:url" content="https://im5tu.io/article/2012/12/flicker-free-forms-and-listview-in-.net/" />
<meta property="og:image" content="https://im5tu.io/img/site-logo.png" />
<meta property="og:site_name" content="Stuart Blackler&#39;s Blog" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@im5tu" />

<style>*{margin:0;padding:0}body{font-size:100%}ul,ol{margin:1em 1em}ul li,ol li{margin:.25em auto}ol ul{margin:0.25em 1em}hr{margin:.5em auto}@font-face{font-family:"Droid Sans";font-style:normal;font-weight:400;src:local("Droid Sans"),url("/fonts/Droid_Sans/DroidSans.woff2") format("woff2")}@font-face{font-family:"Exo";font-style:normal;font-weight:400;src:local("Exo"),url("/fonts/Exo/Exo.woff2") format("woff2")}@font-face{font-family:"Raleway";font-style:normal;font-weight:400;src:local("Raleway"),url("/fonts/Raleway/Raleway.woff2") format("woff2")}html,body{height:100%;background:#f0f0f0;color:#222;text-align:justify;font-family:"Raleway","Helvetica Neue",Helvetica,Arial,sans-serif}h1,h2,h3,h4,h5{font-family:"Exo","Helvetica Neue",Helvetica,Arial,sans-serif;margin:1.25em 0 0.25em 0;font-weight:800;color:#161616;text-align:left}h1{font-size:2.3em;line-height:2.8em}h2{font-size:1.8em;line-height:2.3em}h3{font-size:1.3em;line-height:1.8em}h4{font-size:1.2em;line-height:1.7em}h5{font-size:1.1em;line-height:1.6em}p{font-size:1em;line-height:1.5em;margin-bottom:1em}p code{color:#4DA3CE}p code:hover{color:#89c2df}a:link,a:visited{color:#111;text-decoration:none}a:hover{color:#2B4D5E}pre{background:#fff;border:1px solid #cdcdcd;color:#222}pre:hover{border-color:#8d8d8d}pre,pre code{font-family:'Droid Sans Mono', monospace}.article-list>footer{margin:1em auto;font-size:1.25em;line-height:1.75em}.article-list .article footer{margin-bottom:0}.article-content a:link,.article-content a:visited{color:#328ab6}.article-content a:hover{color:#515151}.article-footer{margin:1em auto}.article blockquote{border-left:5px solid #626262;padding:25px;margin-left:-10px;font-style:italic;color:#959595;margin-bottom:1em;background:#fff}.article blockquote p{margin:0}.article pre{font-size:1em;line-height:1.5em;margin:.5em;padding:.5em;white-space:pre-wrap}.article img{max-width:100%}time.article-header-time{font-style:italic}ul.article-tags{margin-left:.5em;display:inline;list-style:none}ul.article-tags li{display:inline}ul.article-tags li:not(:last-child):after{content:", "}ul.article-tags li:last{margin-right:0}a.article-tag:link,a.article-tag:visited{color:#4DA3CE}a.article-tag:hover{color:#515151}.pageContainer{min-height:100%;position:relative}.pageContainer-content{max-width:980px;margin:0 auto;padding-bottom:6em}@media screen and (min-width: 320px){.pageContainer-content{width:85%}}@media screen and (min-width: 740px){.pageContainer-content{width:80%}}@media screen and (min-width: 980px){.pageContainer-content{width:70%}}#pageHeader{background:#fff;color:#000;padding:.5em 0;border-bottom:1px solid #d0d0d0}#pageHeader:hover{background:#fff;border-bottom-color:#b7b7b7}#pageHeader-wrapper{margin:0 auto}@media screen and (min-width: 320px){#pageHeader-wrapper{width:85%}}@media screen and (min-width: 740px){#pageHeader-wrapper{width:80%}}@media screen and (min-width: 980px){#pageHeader-wrapper{width:70%}}#pageHeader-wrapper:after{content:"";display:table;clear:both}#pageHeader-logo{float:left}#pageHeader-nav{float:right}#pageHeader-nav-ul{float:right;margin:0;list-style:none}#pageHeader-nav-ul li{float:left;margin-left:1em}#pageHeader .pageHeader-imagery{width:2em;height:2em}a.pageHeader-nav-ul-li-link:link,a.pageHeader-nav-ul-li-link:visited{color:#000;font-weight:900;font-family:"Reader","Helvetica Neue",Helvetica,Arial,sans-serif}a.pageHeader-nav-ul-li-link:hover{color:#3b6a81}#logo .logo-path{fill:#000;-webkit-transition:color 1300ms linear;transition:color 1300ms linear}#logo:hover .logo-path{fill:#333;-webkit-animation:animationFrames linear 0.7s;animation:animationFrames linear 0.7s;-webkit-animation-iteration-count:1;animation-iteration-count:1;-webkit-transform-origin:50%;-ms-transform-origin:50%;transform-origin:50%}@-webkit-keyframes animationFrames{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}20%{-webkit-transform:rotate(-5deg);transform:rotate(-5deg)}40%{-webkit-transform:rotate(5deg);transform:rotate(5deg)}60%{-webkit-transform:rotate(-3deg);transform:rotate(-3deg)}80%{-webkit-transform:rotate(2deg);transform:rotate(2deg)}100%{-webkit-transform:rotate(-1deg);transform:rotate(-1deg)}}@keyframes animationFrames{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}20%{-webkit-transform:rotate(-5deg);transform:rotate(-5deg)}40%{-webkit-transform:rotate(5deg);transform:rotate(5deg)}60%{-webkit-transform:rotate(-3deg);transform:rotate(-3deg)}80%{-webkit-transform:rotate(2deg);transform:rotate(2deg)}100%{-webkit-transform:rotate(-1deg);transform:rotate(-1deg)}}#pageFooter{padding:2em 0;width:100%;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-flex-flow:row wrap;-ms-flex-flow:row wrap;flex-flow:row wrap;-webkit-align-content:flex-start;-ms-flex-line-pack:start;align-content:flex-start;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;background:#dedede;color:#5f5f5f;position:absolute;bottom:0;font-size:.9em;line-height:1.4em}#pageFooter a{color:inherit}.pageFooter-section{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;text-align:center}.pageFooter-section:hover{color:#1f1f1f}
</style><link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Stuart Blackler&#39;s Blog" /></head>
<body>
<section class="pageContainer">
    <header id="pageHeader">
    <section id="pageHeader-wrapper">
        <section id="pageHeader-logo">
            <a href="/" title="Homepage">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4405.28 4775.65" id="logo" class="pageHeader-imagery"><g id="logo-layer"><path class="logo-path" d="M3579.85,1950.46C3761.31,1770.51,3872,1521.91,3872,1246.73c0-550.29-571.68-1008.37-995.83-995.83H1729.81a174.58,174.58,0,0,0-33.93-3H678.66a187,187,0,0,0-135,56.84,191.23,191.23,0,0,0-56,135.72c0,100.35,76,184.41,172.6,194a122.28,122.28,0,0,0,16.24.72h32.45l2079.44-9.58c351.86,0,665.36,321.64,665.36,673.47,0,321.64-239,588-549.57,630a663,663,0,0,1-86.3,5.91H1213.45c-47.94,0-89.25,20.67-120.23,53.09-31.73,32.49-50.17,78.23-50.17,128.37,0,100.35,76.72,181.46,170.4,181.46H3351.17c350.38,0,635.87,315,635.87,677.21,0,360.69-315,638.75-665.37,638.75L961.18,3591.73c.72.72.72.72.72,1.51l-396.09-4.47c-126.89,14-302.45,64.18-411.62,173.39C45.74,3870.59,0,3984.19,0,4150.88c0,332.67,240.49,617.42,573.16,617.42l1820.54,7.35c332.66,0,879.28-120.23,1014.27-673.47H2983.82c-39.84,135-218.34,306.16-417.52,320.92l-1964.36-7.42a230.72,230.72,0,0,1-230.88-230.88,231.7,231.7,0,0,1,230.88-230.16l1890.6-9.58c22.15,0,182.94-5.91,202.85,0h714.06c548.81,0,995.83-458.8,995.83-1023.85C4405.28,2427.7,3972.27,2035.32,3579.85,1950.46ZM715.54,481.06v-.72a122.19,122.19,0,0,0,16.24.72Z"/><path class="logo-path" d="M1147.14,0a122.26,122.26,0,0,0,16.24.72h-16.24Z"/><path class="logo-path" d="M1163.39.72h-16.24V0A122.26,122.26,0,0,0,1163.39.72Z"/><path class="logo-path" d="M3421.33,3499.38h-422s-50.89-379.13-552.48-382.08H1271.8c-568,0-1028.28-461-1028.28-1028.25,0-284,115.08-541.5,301-727.35,186.61-185.92,443.31-301,727.32-301H2500.74a176.66,176.66,0,0,1,28-2.23H2848.1a184.82,184.82,0,0,1,185.17,185.21c0,102.51-82.63,185.85-185.17,185.85H1322.7c-182.94,0-348.15,72.32-467.66,190.32C735.53,1737.16,661.76,1898.74,661.76,2078c0,358.52,295.82,655.75,660.93,655.75l1124.2,12.53S3292.25,2747.76,3421.33,3499.38Z"/></g></svg>
            </a>
        </section>
        <nav id="pageHeader-nav">
            <ul id="pageHeader-nav-ul">
                <li><a class="pageHeader-nav-ul-li-link" rel="noopener" target="_blank" href="http://bit.ly/ExploreArbonneWithStu">Arbonne</a></li>
                <li><a class="pageHeader-nav-ul-li-link" rel="noopener" target="_blank" href="https://github.com/im5tu">Github</a></li>
                <li><a class="pageHeader-nav-ul-li-link" rel="noopener" target="_blank" href="https://keybase.io/im5tu">Keybase</a></li>
                <li><a class="pageHeader-nav-ul-li-link" rel="noopener" target="_blank" href="https://twitter.com/im5tu">Twitter</a></li>
                <li><a class="pageHeader-nav-ul-li-link" rel="noopener" target="_blank" href="/article/index.xml">Rss</a></li>
            </ul>
        </nav>
    </section>
</header>
    <section class="pageContainer-content">
        <article class="article">
    <header class="article-header">
        <h1><a href="https://im5tu.io/article/2012/12/flicker-free-forms-and-listview-in-.net/">Flicker free forms and listview in .Net</a></h1>
        <p>Published: <time class="article-header-time" pubdate="pubdate" datetime="2012-12-30T14:51:38">2012-12-30 14:51:38 &#43;0000 UTC</time><p>
    </header>
    <section class="article-content"><p>On a project I have been working on recently, I came across a problem where under Windows an Mdi Child form would flicker when it loads. Trying to find information on what was the cause of this was near impossible. I ended up trying a lot of code snippets that I found when googling the problem and this is what I have come up with.
</p>

<p>Next up, the code. Following this I shall explain, to the best of my ability, what the code does:</p>

<pre><code>'  VB
    Protected Overrides ReadOnly Property CreateParams() As System.Windows.Forms.CreateParams
        Get
            Dim cp As CreateParams = MyBase.CreateParams
            cp.ExStyle = cp.ExStyle Or &amp;H2000000
            Return cp
        End Get
    End Property
</code></pre>

<p>Apparently there are two causes for the flicker that happens to a Windows form. Until writing this post I did not know of the reasons why. <em><a href="http://social.msdn.microsoft.com/Forums/en-US/winforms/thread/aaed00ce-4bc9-424e-8c05-c30213171c2c/">Source MSDN
Forums</a></em></p>

<p><strong>1.</strong> <em>Windows sends a control two messages when a control needs to be painted. The first one (<code>WM_ERASEBKGND</code>) causes the background to be painted (<code>OnPaintBackground</code>), the second causes the foreground to be painted (<code>WM_PAINT</code>, firing <code>OnPaint</code>). Seeing the background drawn first, then the foreground is noticeable when the drawing is slow. Windows Forms has a ready solution for this kind of flicker with ControlStyles.OptimizedDoubleBuffer.</em></p>

<p><strong>2.</strong> <em>A form that has a lot of controls takes a long time to paint. Especially the Button control in its default style is expensive. Once you get over 50 controls, it starts getting noticeable. The Form class
paints its background first and leaves &ldquo;holes&rdquo; where the controls need to go. Those holes are usually white, black when you use the <code>Opacity</code> or <code>TransparencyKey property</code>. Then each control gets painted, filling
in the holes. The visual effect is ugly and there&rsquo;s no ready solution for it in Windows Forms. <code>Double-buffering</code> can&rsquo;t solve it as it only works for a single control, not a composite set of controls.</em></p>

<p>The <code>CreateParams</code> property should only be overridden when wrapping an existing Windows control or when you need to set the style of the control. Microsoft recommend that you inherit the problem control and
then override the <code>CreateParams</code>, not the way that I actually used it.</p>

<p>I applied this at the top of every form in my code, ran the code under Windows 7 (my development machine) and Windows XP (the target machine) and everything appeared to render a lot better with the nasty double
flicker gone. All I know about the code above, is that it overrides the styling of the controls and waits until the form is fully painted before showing the form.</p>

<p>It wasn&rsquo;t until further testing of the code that I discovered that the original code caused an MDI child form to max out the CPU and hang the application. I tried commenting out all of the code, removing any
background threads that were running (including timers etc) and as soon as I enabled the code, it would hang the application again. This left me and my colleagues very stumped for a few hours. After this period of
time, I bit the bullet and decided to uncomment every section of my code until I could find the problem.</p>

<p>Eventually I found the code above to be the problem, which worked fine under Windows 7. So the solution was quiet easy, detect what version of the operating system we are on and only apply the style if we are on
Vista or higher.</p>

<pre><code>'  VB
    Protected Overrides ReadOnly Property CreateParams() As System.Windows.Forms.CreateParams
        Get
            Dim cp As CreateParams = MyBase.CreateParams
            Dim OSVer As Version = System.Environment.OSVersion.Version()
            Select Case OSVer.Major
                Case Is &lt;= 5
                Case 5
                    If OSVer.Minor &gt; 0 Then
                        cp.ExStyle = cp.ExStyle Or &amp;H2000000
                    End If
                Case Is &gt; 5
                    cp.ExStyle = cp.ExStyle Or &amp;H2000000
                Case Else
            End Select
            Return cp
        End Get
    End Property
</code></pre>

<p>So I had finally fixed the problem with the CPU usage. Deployed the version for the client to test and everything was ok. By this time, I had a massive headache and it wasn&rsquo;t quiet the end of the day. What a
better way to end the day but by ending off with another rending issue. Although I had fixed the issue with the CPU, I had noticed that when you moved the form, and loading the form in some cases, a list view in
details mode would not render correctly.</p>

<p>After reading around about the issue, I have merged from a number of source&rsquo;s to create a flicker free list view. To use the code, place the class into your project, open up the target form&rsquo;s designer code (<em>You
will need to show all files in VS</em>) and replace the instances of <code>ListView</code> with <code>FlickerFreeListView</code>. Here is the code:</p>

<pre><code>Public Class FlickerFreeListView
    Inherits System.Windows.Forms.ListView

    Public Sub New()

        MyBase.New()

        Me.SetStyle(ControlStyles.Opaque, True)
        Me.SetStyle(ControlStyles.OptimizedDoubleBuffer, True)
        Me.SetStyle(ControlStyles.ResizeRedraw, True)
        Me.SetStyle(ControlStyles.AllPaintingInWmPaint, True)
        Me.SetStyle(ControlStyles.EnableNotifyMessage, True)

    End Sub

    Protected Overrides Sub OnNotifyMessage(ByVal m As Message)
        If (m.Msg &lt;&gt; &amp;H14) Then
            MyBase.OnNotifyMessage(m)
        End If
    End Sub

End Class
</code></pre>

<p>The code basically blocks the background from being re-drawn every time an item is added into the <code>ListView</code> control. It also sets the <code>OptimizedDoubleBuffer</code> to help prevent any issues, amongst other things.</p>

<p>I hope that this will help someone have less of a headache that I had when I was looking around for a solution to this problem. Feel free to try it at your own risk and notify me if you have any
troubles.</p></section>
    <footer class="article-footer">
        <hr />Tags: <ul class="article-tags">
    <li><a class="article-tag" href="/tags/vb/">vb</a></li><li><a class="article-tag" href="/tags/dotnet/">dotnet</a></li>
</ul></footer>
</article>
    </section>
    <footer id="pageFooter">
    <section id="pageFooter-copyright" class="pageFooter-section">
        &copy; 2016 Stuart Blackler
    </section>
    <section id="pageFooter-details" class="pageFooter-section">
        <a href="https://github.com/im5tu/im5tu-hugo" rel="noopener" target="_blank">Edit me on Github</a>
    </section>
    <section id="pageFooter-scroll" class="pageFooter-section">
        <a id="pageFooter-scroll-link" href="#">Scroll To Top</a>
    </section>
</footer>
</section>
<script src="/js/site-e232180f.js" defer></script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5838c774d027e891" defer></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-88036425-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>