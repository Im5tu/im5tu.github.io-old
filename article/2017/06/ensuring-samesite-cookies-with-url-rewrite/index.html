<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ensuring samesite cookies with URL Rewrite - Stuart Blackler&#39;s Blog</title>
    <link rel="canonical" href="https://im5tu.io/article/2017/06/ensuring-samesite-cookies-with-url-rewrite/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="description" content="A handy URL Rewrite snippet to mark cookies as samesite.">
    
    
    <meta property="og:title" content="Ensuring samesite cookies with URL Rewrite - Stuart Blackler&#39;s Blog" />
<meta property="og:type" content="website" />

<meta property="og:description" content="A handy URL Rewrite snippet to mark cookies as samesite.">

<meta property="og:url" content="https://im5tu.io/article/2017/06/ensuring-samesite-cookies-with-url-rewrite/" />
<meta property="og:image" content="https://im5tu.io/img/profile.jpg" />
<meta property="og:site_name" content="Stuart Blackler&#39;s Blog" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@im5tu" />

<style>*{margin:0;padding:0}body{font-size:100%}ul,ol{margin:1em 1em}ul li,ol li{margin:.25em auto}ol ul{margin:0.25em 1em}hr{margin:.5em auto}html,body{height:100%;background:#f9f9f9;color:#444;text-align:justify;font-family:"Rajdhani","Helvetica Neue",Helvetica,Arial,sans-serif}h1,h2,h3,h4,h5{font-family:"Michroma","Helvetica Neue",Helvetica,Arial,sans-serif;margin:1.25em 0 0.25em 0;font-weight:800;color:#161616;text-align:left}h1{font-size:2.3em;line-height:2.8em}h2{font-size:1.8em;line-height:2.3em}h3{font-size:1.3em;line-height:1.8em}h4{font-size:1.2em;line-height:1.7em}h5{font-size:1.1em;line-height:1.6em}p{margin:1.5em 0}p,p li{font-size:1.1em;line-height:1.6em}p code,ul li code,ol li code{color:#b30000}p code:hover,ul li code:hover,ol li code:hover{color:#ff0101}a:link,a:visited{color:#111;text-decoration:none}a:hover{color:#800}pre{background:#fff;border:1px solid #cdcdcd;color:#444}pre:hover{border-color:#8d8d8d}pre,pre code{font-family:'Cutive Mono', monospace}.pageWrap{margin:0 auto}@media screen and (min-width: 320px){.pageWrap{width:97%}}@media screen and (min-width: 740px){.pageWrap{width:90%}}@media screen and (min-width: 980px){.pageWrap{width:80%}}.pageWrap:after{content:"";display:table;clear:both}.article-list>footer{margin:1em auto;font-size:1.25em;line-height:1.75em}.article-list .article footer{margin-bottom:0}.article{background:#fff;padding:0 2em 1em 2em;border:1px solid #d0d0d0;margin:2em 0}.article-content a:link,.article-content a:visited{color:maroon}.article-content a:hover{color:#515151}.article-footer{margin:1em auto}.article blockquote{border-left:5px solid #848484;padding:25px;margin-left:-10px;font-style:italic;font-weight:bold;margin-bottom:1em;background:#fff;font-size:1.5em;line-height:2em}.article blockquote p{margin:0}.article pre{font-size:1em;line-height:1.5em;margin:.5em;padding:.5em;white-space:pre-wrap;-webkit-transition:background 2s ease-in-out;-o-transition:background 2s ease-in-out;transition:background 2s ease-in-out;-webkit-transition:border-color 500ms ease-in-out;-o-transition:border-color 500ms ease-in-out;transition:border-color 500ms ease-in-out;-webkit-transition:color 75ms ease-in-out;-o-transition:color 75ms ease-in-out;transition:color 75ms ease-in-out}.article pre:hover{color:#fff;background:#333;border-color:#777}.article img{max-width:100%}.article .article-header p{font-style:italic}.article .warning{margin:2em;padding:1em 2em;color:#8A6D3B;background-color:#fcf8e3;border:1px solid #8A6D3B;text-align:center}.article .warning h1,.article .warning h2,.article .warningh3,.article .warning h4,.article .warning h5{font-weight:700;margin:0;padding:0;text-align:center}ul.article-tags{margin-left:.5em;display:inline;list-style:none}ul.article-tags li{display:inline}ul.article-tags li:not(:last-child):after{content:", "}ul.article-tags li:last{margin-right:0}a.article-tag:link,a.article-tag:visited{color:#b30000}a.article-tag:hover{color:#515151}.pageContainer{min-height:100%;position:relative}.pageContainer-content{margin:0 auto;padding-bottom:6em}#pageHeader{background:#fff;color:#000;padding:.5em 0;border-bottom:1px solid #d0d0d0}#pageHeader:hover{background:#fff;border-bottom-color:#b7b7b7}#pageHeader-nav{float:right}#pageHeader-nav-ul{float:right;margin:0;list-style:none}#pageHeader-nav-ul li{float:left;margin-left:1em}#pageHeader-about section{width:100%;clear:both;text-align:center;margin:2em 0}#pageHeader-about h4{font-style:italic}#pageHeader-about h1,#pageHeader-about h2,#pageHeader-about h3,#pageHeader-about h4{text-align:center;line-height:normal}#pageHeader-about-links-nav-ul{margin:0;padding:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;list-style:none}#pageHeader-about-links-nav-ul li{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-align:start;-webkit-align-items:flex-start;-ms-flex-align:start;align-items:flex-start}a.pageHeader-nav-ul-li-link:link,a.pageHeader-nav-ul-li-link:visited{color:#000;font-weight:900;font-family:"Reader","Helvetica Neue",Helvetica,Arial,sans-serif}a.pageHeader-nav-ul-li-link:hover{color:#b00}#pageFooter{padding:2em 0;width:100%;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-webkit-flex-flow:row wrap;-ms-flex-flow:row wrap;flex-flow:row wrap;-webkit-align-content:flex-start;-ms-flex-line-pack:start;align-content:flex-start;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;background:#dedede;color:#5f5f5f;position:absolute;bottom:0;font-size:.9em;line-height:1.4em}#pageFooter a{color:inherit}.pageFooter-section{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;text-align:center}.pageFooter-section:hover{color:#1f1f1f}
</style>
<link href="https://fonts.googleapis.com/css?family=Cutive+Mono|Michroma|Rajdhani" rel="stylesheet"><link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Stuart Blackler&#39;s Blog" /></head>
<body>
<section class="pageContainer">
    <header id="pageHeader">
    <section id="pageHeader-about" class="pageWrap" itemscope itemtype="http://schema.org/person">
        <section id="pageHeader-about-title">
            <h1 itemprop="name"><a href="/" title="Homepage">Stuart Blackler</a></h1>
            <h4 itemprop="jobtitle">Lead Architect / Software Consultant / Crossfitter</h4>
        </section>
        <section id="pageHeader-about-description">
            <p itemprop="description">I am a lead architect at the UK&#39;s first clearing bank in 250 years, ClearBank. I specialise in designing and building backend systems, specifically messaging based systems and RESTful API&#39;s. I am also one of two UK representives in an ISO working group looking at API&#39;s in financial services. Follow my journey via the channels below:</p>
        </section>
        <section id="pageHeader-about-links">
            <nav id="pageHeader-about-links-nav">
                <ul id="pageHeader-about-links-nav-ul">
                    <li><a class="pageHeader-about-links-nav-ul-li-link" rel="noopener" target="_blank" href="https://github.com/im5tu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></a></li>
                    <li><a class="pageHeader-about-links-nav-ul-li-link" rel="noopener" target="_blank" href="https://instagram.com/cf_stu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M11.984 16.815c2.596 0 4.706-2.111 4.706-4.707 0-1.409-.623-2.674-1.606-3.538-.346-.303-.735-.556-1.158-.748-.593-.27-1.249-.421-1.941-.421s-1.349.151-1.941.421c-.424.194-.814.447-1.158.749-.985.864-1.608 2.129-1.608 3.538 0 2.595 2.112 4.706 4.706 4.706zm.016-8.184c1.921 0 3.479 1.557 3.479 3.478 0 1.921-1.558 3.479-3.479 3.479s-3.479-1.557-3.479-3.479c0-1.921 1.558-3.478 3.479-3.478zm5.223.369h6.777v10.278c0 2.608-2.114 4.722-4.722 4.722h-14.493c-2.608 0-4.785-2.114-4.785-4.722v-10.278h6.747c-.544.913-.872 1.969-.872 3.109 0 3.374 2.735 6.109 6.109 6.109s6.109-2.735 6.109-6.109c.001-1.14-.327-2.196-.87-3.109zm2.055-9h-12.278v5h-1v-5h-1v5h-1v-4.923c-.346.057-.682.143-1 .27v4.653h-1v-4.102c-1.202.857-2 2.246-2 3.824v3.278h7.473c1.167-1.282 2.798-2 4.511-2 1.722 0 3.351.725 4.511 2h7.505v-3.278c0-2.608-2.114-4.722-4.722-4.722zm2.722 5.265c0 .406-.333.735-.745.735h-2.511c-.411 0-.744-.329-.744-.735v-2.53c0-.406.333-.735.744-.735h2.511c.412 0 .745.329.745.735v2.53z"/></svg></a></li>
                    <li><a class="pageHeader-about-links-nav-ul-li-link" rel="noopener" target="_blank" href="https://keybase.io/im5tu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M21 21v3h-18v-3h18zm-13-15c0-2.206 1.795-4 4-4s4 1.794 4 4v3h2v-3c0-3.313-2.687-6-6-6s-6 2.687-6 6v3h2v-3zm13 8v-3h-18v3h18zm0 5v-3h-18v3h18z"/></svg></a></li>
                    <li><a class="pageHeader-about-links-nav-ul-li-link" rel="noopener" target="_blank" href="https://www.linkedin.com/in/im5tu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h4.969v-8.399c0-4.67 6.029-5.052 6.029 0v8.399h4.988v-10.131c0-7.88-8.922-7.593-11.018-3.714v-2.155z"/></svg></a></li>
                    <li><a class="pageHeader-about-links-nav-ul-li-link" rel="noopener" target="_blank" href="https://twitter.com/im5tu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg></a></li>
                    <li><a class="pageHeader-about-links-nav-ul-li-link" rel="noopener" target="_blank" href="/article/index.xml"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></a></li>
                </ul>
            </nav>
        </section>
    </section>
</header>
    <section class="pageContainer-content pageWrap">
        <article class="article" itemscope itemtype="http://schema.org/blog">
    <header class="article-header">
        <h1><a href="https://im5tu.io/article/2017/06/ensuring-samesite-cookies-with-url-rewrite/" itemprop="name">Ensuring samesite cookies with URL Rewrite</a></h1>
        <p>Published by <span itemprop="author">Stuart Blackler</span> <time itemprop="datecreated" class="article-header-time" pubdate="pubdate" datetime="2017-06-11T20:50:11">2017-06-11 20:50:11 &#43;0100 BST</time></p>
    </header>
    <section class="article-content" itemprop="text"><p>In this article, we will increase our websites level of protecting against Cross-Site Request Forgery and Cross-Site Script Inclusion attacks by appending an additional modifier to the <code>Set-Cookie</code> HTTP header.</p>

<p></p>

<p>This article extends my <a href="/article/2017/06/ensuring-secure-cookies-with-url-rewrite/">previous article</a> by using an outbound rewrite rule again.</p>

<h2 id="what-are-samesite-cookies">What are SameSite cookies?</h2>

<p>In a cross-origin request context, which is when you request resources from a different site, any cookies that you have for that site are also sent. We can restrict this through applying the <code>SameSite</code> modifier to the <code>Set-Cookie</code> HTTP header.</p>

<p>The goals of SameSite cookies are to:</p>

<ul>
<li>Prevent cross origin timing attacks;</li>
<li>Prevent cross origin script inclusion;</li>
<li>Prevent cross site request forgery;</li>
<li>Increasing privacy protections</li>
</ul>

<p>When the modification is applied to the <code>Set-Cookie</code> HTTP header, the browser will only send cookies in a first party context (ie: when you are using the website directly).</p>

<p>There are two possible modes for the attribute: Strict &amp; lax. The difference is which HTTP verbs the security policy should be applied to. In lax mode, cookies are not sent when <code>POST</code>ing to a third party site. In strict mode, cookies are not sent when <code>GET</code>ting or <code>POST</code>ing to a third party site. Strict mode is the default mode if the mode is obmitted.</p>

<h2 id="ensuring-our-cookies-are-marked-secure-with-url-rewrite">Ensuring our cookies are marked secure with URL Rewrite</h2>

<p>As per the snippet in our previous post, we are going to create an outbound rule (which lives under <code>system.web &gt; rewrite &gt; outboundRules</code> in our <code>web.config</code>). This rewrite snippet requires two portions: the rule and a set of preconditions:</p>

<pre><code>&lt;rewrite&gt;
    &lt;outboundRules&gt; 
        &lt;rule name=&quot;Ensure samesite Cookies&quot; preCondition=&quot;Missing samesite cookie&quot;&gt;
        &lt;match serverVariable=&quot;RESPONSE_Set_Cookie&quot; pattern=&quot;.*&quot; negate=&quot;false&quot; /&gt;
        &lt;action type=&quot;Rewrite&quot; value=&quot;{R:0}; SameSite=strict&quot; /&gt;
        &lt;/rule&gt;
        &lt;preConditions&gt;
            &lt;preCondition name=&quot;Missing samesite cookie&quot;&gt;
                &lt;!-- Don't remove the first line here, it does do stuff! --&gt;
                &lt;add input=&quot;{RESPONSE_Set_Cookie}&quot; pattern=&quot;.&quot; /&gt;
                &lt;add input=&quot;{RESPONSE_Set_Cookie}&quot; pattern=&quot;; SameSite=strict&quot; negate=&quot;true&quot; /&gt;
            &lt;/preCondition&gt;
        &lt;/preconditions&gt;
    &lt;/outboundRules&gt;
&lt;/rewrite&gt;
</code></pre>

<p>Within our rule, we are defining the name of the rule which can be viewed inside of <code>inetmgr (IIS Manager)</code>. Next, we match the server varible for a <code>Set-Cookie</code> HTTP header (<code>RESPONSE_Set_Cookie</code>) and ensure that it&rsquo;s present for us to continue. For our action, we rewrite the <code>Set-Cookie</code> header to be the original value, with the <code>SameSite</code> modifier appended with the mode set to strict as detailed above. Alternatively, you can use <code>SameSite=lax</code> for the lax mode of operation.</p>

<p>Within the precondition, which is matched by name to the <code>preCondition</code> attribute in the rule, we do two things:</p>

<ul>
<li>(<em>I think, see below</em>) Make sure that the <code>Set-Cookie</code> header has been set (via the server variable <code>{RESPONSE_Set_Cookie}</code>);</li>
<li>Make sure that we do not already have the <code>SameSite</code> modifier set</li>
</ul>

<p>As per my previous post, due to a knowledge gap, the first line is required within the pre-condition or funky things happen.</p>

<p>That&rsquo;s it. If you check your debug tool of choice after implementing this, you should see that all cookies are now sent with the <code>SameSite</code> modifier.</p>

<h2 id="other-posts-in-this-series">Other Posts In This Series</h2>

<ol>
<li><a href="/article/2017/06/up-and-running-with-url-rewrite---going-from-http-to-https/">Up and running with URL Rewrite - going from HTTP to HTTPS</a></li>
<li><a href="/article/2017/06/canonical-host-urls-with-url-rewrite/">Canonical host urls with URL Rewrite</a></li>
<li><a href="/article/2017/06/removing-trailing-slashes-with-url-rewrite/">Removing trailing slashes with URL Rewrite</a></li>
<li><a href="/article/2017/06/ensuring-httponly-cookies-with-url-rewrite/">Ensuring httpOnly cookies with URL Rewrite</a></li>
<li><a href="/article/2017/06/ensuring-secure-cookies-with-url-rewrite/">Ensuring secure cookies with URL Rewrite</a></li>
<li><a href="/article/2017/06/ensuring-samesite-cookies-with-url-rewrite/">Ensuring samesite cookies with URL Rewrite</a> <em>(This Post)</em></li>
</ol></section>
    <footer class="article-footer">
        <hr />Tags: <ul class="article-tags">
    <li><a class="article-tag" href="/tags/iis/">IIS</a></li><li><a class="article-tag" href="/tags/url-rewrite/">Url Rewrite</a></li><li><a class="article-tag" href="/tags/cookies/">Cookies</a></li>
</ul></footer>
</article>
    </section>
    <footer id="pageFooter">
    <section id="pageFooter-copyright" class="pageFooter-section">
        &copy; 2016 Stuart Blackler
    </section>
    <section id="pageFooter-details" class="pageFooter-section">
        <a href="https://github.com/im5tu/im5tu-hugo" rel="noopener" target="_blank">Edit me on Github</a>
    </section>
    <section id="pageFooter-scroll" class="pageFooter-section">
        <a id="pageFooter-scroll-link" href="#">Scroll To Top</a>
    </section>
</footer>
</section>
<script src="/js/site-e232180f.js" defer></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-88036425-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>