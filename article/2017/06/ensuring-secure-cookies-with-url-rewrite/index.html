<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Ensuring secure cookies with URL Rewrite - Stuart Blackler's Blog</title><link rel=canonical href=https://im5tu.io/article/2017/06/ensuring-secure-cookies-with-url-rewrite/><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><meta name=description content="A handy URL Rewrite snippet to mark cookies as secure."><meta property="og:title" content="Ensuring secure cookies with URL Rewrite - Stuart Blackler's Blog"><meta property="og:type" content="website"><meta property="og:description" content="A handy URL Rewrite snippet to mark cookies as secure."><meta property="og:url" content="https://im5tu.io/article/2017/06/ensuring-secure-cookies-with-url-rewrite/"><meta property="og:image" content="https://im5tu.io/img/profile.jpg"><meta property="og:site_name" content="Stuart Blackler's Blog"><meta name=twitter:card content="summary"><meta name=twitter:site content="@im5tu"><style>body,html{height:100%;color:#303030;font-family:noto sans,helvetica neue,Helvetica,Arial,sans-serif;font-display:auto;line-height:1.8em}h1,h2,h3,h4,h5,h6{font-family:Comfortaa,helvetica neue,Helvetica,Arial,sans-serif;font-display:auto}p{margin:1.5em 0}blockquote{border-left:5px solid #454545;background-color:#fafafa;padding:.5em 1.5em}blockquote,blockquote p{color:#494949}blockquote~blockquote{margin-top:0;margin-bottom:0}.warning{margin:0 auto;border:1px solid #ff9500;color:#ff9500;background-color:#fff;text-align:center}.series{font-style:italic}.series p{margin-bottom:0}.series ol{margin:0}.pageContainer{text-align:justify}.pageWrap{margin:0 auto;max-width:1400px}@media screen and (min-width:320px){.pageWrap{width:97%}}@media screen and (min-width:740px){.pageWrap{width:90%}}@media screen and (min-width:980px){.pageWrap{width:80%}}.pageWrap:after{content:"";display:table;clear:both}a{font-family:Comfortaa,helvetica neue,Helvetica,Arial,sans-serif;font-display:auto}a:link,a:visited{color:#149fd1}a:link{text-decoration:none}a:hover{color:#2db9eb;text-decoration:underline}#pageHeader-about{border-bottom:1px solid #eaeaea}#pageHeader-about-title a{font-size:1.2em}#pageHeader-about-title a:link,#pageHeader-about-title a:visited{color:#232323}#pageHeader-about-title a:first-child{font-size:1.1em;color:#149fd1;text-transform:none}.article-list a{color:#0a0a0a}.article-list a:hover{color:#2db9eb;text-decoration:underline}.article-content li code,.article-content p code{color:#149fd1;background-color:rgba(27,31,35,.05)}.article-content li code:hover,.article-content p code:hover{opacity:.5}.article img{max-width:100%}ul.article-tags{display:inline;padding:0}ul.article-tags li{display:inline;padding:0 1em}ul.article-tags li a:link{text-decoration:underline}table{width:100%}table *{padding:0;margin:0}table th{display:-webkit-box;display:flex;width:100%;background:#000;color:#fff;padding:1em}table tr{display:-webkit-box;display:flex;width:100%}table tr:hover{opacity:.7}table tr:first-child{padding:0}table tr:nth-of-type(odd){background:#eee}table td{-webkit-box-flex:1;flex:1 1 20%;text-align:left;padding:1em}pre{line-height:1.4em}code{font-size:1.2em}@media(prefers-color-scheme:dark){body,html{color:#eaeaea;background:#323232}h1,h2,h3,h4,h5,h6{color:#fefefe}a:link,a:visited{color:#149fd1}.article-list h1 a:link,.article-list h1 a:visited,.article-list h2 a:link,.article-list h2 a:visited,.article-list h3 a:link,.article-list h3 a:visited,.article-list h4 a:link,.article-list h4 a:visited,.article-list h5 a:link,.article-list h5 a:visited,.article-list h6 a:link,.article-list h6 a:visited{color:#fefefe}#pageHeader-about-title a:link,#pageHeader-about-title a:visited{color:#dedede}#pageHeader-about-title a:first-child{color:#149fd1}table tr:nth-of-type(odd){background:#767676}pre,pre code{background:#dcdcdc!important;color:#323232}}.copy-code-button{float:right;display:block;padding:8px 12px;font-size:.9em;background-color:#e2e2e2;border:1px solid #e2e2e2;border-radius:0 0 10px 10px;-webkit-transition:all 250ms ease;transition:all 250ms ease;opacity:0}.copy-code-button:hover{cursor:pointer;opacity:.7;border-style:solid}.copy-code-button:focus{background-color:#e2e2e2;outline:0;border-style:solid}.copy-code-button:active{background-color:#e2e2e2;opacity:.5;border-style:solid}pre:hover .copy-code-button{opacity:1}.copy-code-button~pre{position:relative}@media print{.copy-code-button{display:none}}@media(prefers-color-scheme:dark){.copy-code-button{background-color:#969696;color:#323232}}</style><link href="https://fonts.googleapis.com/css?family=Comfortaa|Noto+Sans&display=swap" rel=stylesheet><link href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/tomorrow.min.css rel=stylesheet><link href=/article/index.xml rel=alternate type=application/rss+xml title="Stuart Blackler's Blog"></head><body><section class=pageContainer><header id=pageHeader><section id=pageHeader-about class=pageWrap itemscope itemtype=http://schema.org/person><section id=pageHeader-about-title><h1 itemprop=name><a href=/ title="Stuart Blackler">@im5tu</a> / <a href=https://im5tu.io/article/2017/06/ensuring-secure-cookies-with-url-rewrite/>Ensuring secure cookies with URL Rewrite</a></h1></section></section></header><section class="pageContainer-content pageWrap"><article class=article itemscope itemtype=http://schema.org/blog><section class="series series-header"><p>This article is part of the <a href=#series>Url Rewriting</a> series. You are reading part 5 of 6.</p></section><section class=article-content itemprop=text><p>In this article, we will take a look at secure cookies, that is by appending an additional modifier to the <code>Set-Cookie</code> HTTP header.</p><p>This article extends my <a href=/article/2017/06/ensuring-httponly-cookies-with-url-rewrite/>previous article</a> by using an outbound rewrite rule again.</p><h2 id=what-are-secure-cookies>What are secure cookies?</h2><p>As the name suggests, by appending <code>secure</code> to the <code>Set-Cookie</code> HTTP header, we instruct a browser to only send the cookie when the connection to the web server is secure. This helps protect against any information leakage or eves-dropping.</p><p><em>For more information, checkout <a href=https://scotthelme.co.uk/tough-cookies/>Scott Helme's incredible post</a> on getting tougher cookies.</em></p><h2 id=ensuring-our-cookies-are-marked-secure-with-url-rewrite>Ensuring our cookies are marked secure with URL Rewrite</h2><p>As per the snippet in our previous post, we are going to create an outbound rule (which lives under <code>system.web > rewrite > outboundRules</code> in our <code>web.config</code>). This rewrite snippet requires two portions, the rule and a set of preconditions:</p><pre><code class=language-xml>&lt;rewrite&gt;
    &lt;outboundRules&gt; 
        &lt;rule name=&quot;Ensure secure Cookies&quot; preCondition=&quot;Missing secure cookie&quot;&gt;
            &lt;match serverVariable=&quot;RESPONSE_Set_Cookie&quot; pattern=&quot;.*&quot; negate=&quot;false&quot; /&gt;
            &lt;action type=&quot;Rewrite&quot; value=&quot;{R:0}; secure&quot; /&gt;
        &lt;/rule&gt;
        &lt;preConditions&gt;
            &lt;preCondition name=&quot;Missing secure cookie&quot;&gt;
                &lt;!-- Don't remove the first line here, it does do stuff! --&gt;
                &lt;add input=&quot;{RESPONSE_Set_Cookie}&quot; pattern=&quot;.&quot; /&gt;
                &lt;add input=&quot;{RESPONSE_Set_Cookie}&quot; pattern=&quot;; secure&quot; negate=&quot;true&quot; /&gt;
            &lt;/preCondition&gt;
        &lt;/preconditions&gt;
    &lt;/outboundRules&gt;
&lt;/rewrite&gt;
</code></pre><p>Within our rule, we are defining the name of the rule which can be viewed inside of <code>inetmgr (IIS Manager)</code>. Next, we match the server varible for a <code>Set-Cookie</code> HTTP header (<code>RESPONSE_Set_Cookie</code>) and ensure that it's present for us to continue. For our action, we rewrite the <code>Set-Cookie</code> header to be the original value, with the <code>secure</code> modifier appended.</p><p>Within the precondition, which is matched by name to the <code>preCondition</code> attribute in the rule, we do two things:</p><ul><li>(<em>I think, see below</em>) Make sure that the <code>Set-Cookie</code> header has been set (via the server variable <code>{RESPONSE_Set_Cookie}</code>);</li><li>Make sure that we do not already have the <code>secure</code> modifier set</li></ul><p>As per my previous post, due to a knowledge gap, the first line is required within the pre-condition or funky things happen.</p><p>That's it. If you check your debug tool of choice after implementing this, you should see that all cookies are now sent with the <code>secure</code> modifier.</p></section><footer class=article-footer><section class=series><a name=series></a><h3>Other posts in the <b>Url Rewriting</b> series:</h3><ol><li><a href=https://im5tu.io/article/2017/06/up-and-running-with-url-rewrite-going-from-http-to-https/>Up and running with URL Rewrite - going from HTTP to HTTPS</a></li><li><a href=https://im5tu.io/article/2017/06/canonical-host-urls-with-url-rewrite/>Canonical host urls with URL Rewrite</a></li><li><a href=https://im5tu.io/article/2017/06/removing-trailing-slashes-with-url-rewrite/>Removing trailing slashes with URL Rewrite</a></li><li><a href=https://im5tu.io/article/2017/06/ensuring-httponly-cookies-with-url-rewrite/>Ensuring httpOnly cookies with URL Rewrite</a></li><li>Ensuring secure cookies with URL Rewrite (This Article)</li><li><a href=https://im5tu.io/article/2017/06/ensuring-samesite-cookies-with-url-rewrite/>Ensuring samesite cookies with URL Rewrite</a></li></ol></section><hr>Tags:<ul class=article-tags><li><a class=article-tag href=/tags/iis/>IIS</a></li><li><a class=article-tag href=/tags/url-rewrite/>Url Rewrite</a></li><li><a class=article-tag href=/tags/cookies/>Cookies</a></li></ul></footer></article></section><footer id=pageFooter class=pageWrap><p>&copy; 2020 <span itemprop=author>Stuart Blackler</span>. Last Updated: <time itemprop=datecreated class=article-header-time pubdate=pubdate datetime=2017-06-11T20:38:07>2017-06-11 20:38:07 +0100 BST</time>. <a id=pageFooter-scroll-link href=#>Scroll To Top</a>.</p></footer></section><script src=/js/site-54e01995.js defer></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-88036425-1','auto');ga('send','pageview');</script><script data-ad-client=ca-pub-8597760177900459 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>