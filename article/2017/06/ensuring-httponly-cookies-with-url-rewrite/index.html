<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ensuring httpOnly cookies with URL Rewrite - Stuart Blackler&#39;s Blog</title>
    <link rel="canonical" href="https://im5tu.io/article/2017/06/ensuring-httponly-cookies-with-url-rewrite/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="description" content="A brief overview of cookies, why we want them to be httpOnly and how we can ensure this via URL Rewrite.">
    
    
    <meta property="og:title" content="Ensuring httpOnly cookies with URL Rewrite - Stuart Blackler&#39;s Blog" />
<meta property="og:type" content="website" />

<meta property="og:description" content="A brief overview of cookies, why we want them to be httpOnly and how we can ensure this via URL Rewrite.">

<meta property="og:url" content="https://im5tu.io/article/2017/06/ensuring-httponly-cookies-with-url-rewrite/" />
<meta property="og:image" content="https://im5tu.io/img/profile.jpg" />
<meta property="og:site_name" content="Stuart Blackler&#39;s Blog" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@im5tu" />

<style>html, body {
  height: 100%;
  color: #303030;
  font-family: "Noto Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-display: auto;
}

h1, h2, h3, h4, h5, h6 {
  font-family: "Comfortaa", "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-display: auto;
}

p {
  margin: 1.5em 0;
}

blockquote {
  border-left: 5px solid #454545;
  background-color: #fafafa;
  padding: 0.5em 1.5em;
}
blockquote, blockquote p {
  color: #494949;
}
blockquote ~ blockquote {
  margin-top: 0;
  margin-bottom: 0;
}

.pageContainer {
  text-align: justify;
}

.pageWrap {
  margin: 0 auto;
  max-width: 1400px;
}
@media screen and (min-width: 320px) {
  .pageWrap {
    width: 97%;
  }
}
@media screen and (min-width: 740px) {
  .pageWrap {
    width: 90%;
  }
}
@media screen and (min-width: 980px) {
  .pageWrap {
    width: 80%;
  }
}
.pageWrap:after {
  content: "";
  display: table;
  clear: both;
}

a {
  font-family: "Comfortaa", "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-display: auto;
}
a:link, a:visited {
  color: #149fd1;
}
a:link {
  text-decoration: none;
}
a:hover {
  color: #2db9eb;
  text-decoration: underline;
}

#pageHeader-about {
  border-bottom: 1px solid #eaeaea;
}

#pageHeader-about-title a {
  font-size: 1.2em;
}
#pageHeader-about-title a:link, #pageHeader-about-title a:visited {
  color: #232323;
}
#pageHeader-about-title a:first-child {
  font-size: 1.1em;
  color: #149fd1;
  text-transform: none;
}

.article-list a {
  color: #0a0a0a;
}
.article-list a:hover {
  color: #2db9eb;
  text-decoration: underline;
}

.article-content p code, .article-content li code {
  color: #149fd1;
  background-color: rgba(27, 31, 35, 0.05);
}
.article-content p code:hover, .article-content li code:hover {
  opacity: 0.5;
}

.article img {
  max-width: 100%;
}

.copy-code-button {
  float: right;
  display: block;
  padding: 3px 8px;
  font-size: 0.8em;
  background-color: #e2e2e2;
  border: 1px solid #e2e2e2;
  border-radius: 0 0 10px 10px;
  -webkit-transition: all 250ms ease;
  transition: all 250ms ease;
  opacity: 0;
}
.copy-code-button:hover {
  cursor: pointer;
  opacity: 0.7;
  border-style: solid;
}
.copy-code-button:focus {
  background-color: #e2e2e2;
  outline: 0;
  border-style: solid;
}
.copy-code-button:active {
  background-color: #e2e2e2;
  opacity: 0.5;
  border-style: solid;
}

pre:hover .copy-code-button {
  opacity: 1;
}

.copy-code-button ~ pre {
  position: relative;
}

@media print {
  .copy-code-button {
    display: none;
  }
}</style>
<link href="https://fonts.googleapis.com/css?family=Comfortaa|Noto+Sans&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/tomorrow.min.css" rel="stylesheet"><link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Stuart Blackler&#39;s Blog" /></head>
<body>
<section class="pageContainer">
    <header id="pageHeader">
    <section id="pageHeader-about" class="pageWrap" itemscope itemtype="http://schema.org/person">
        <section id="pageHeader-about-title">
            <h1 itemprop="name"><a href="/" title="Stuart Blackler">@im5tu</a> / <a href="https://im5tu.io/article/2017/06/ensuring-httponly-cookies-with-url-rewrite/">Ensuring httpOnly cookies with URL Rewrite</a></h1>
        </section>
    </section>
</header>
    <section class="pageContainer-content pageWrap">
        <article class="article" itemscope itemtype="http://schema.org/blog">
    <section class="article-content" itemprop="text"><p>In this article, I will give a brief overview of cookies, why we want them to be httpOnly and how we can ensure this via URL Rewrite. We will also be creating our first outbound rewrite rule with a pre-condition.</p>
<p>See my <a href="/article/2017/06/removing-trailing-slashes-with-url-rewrite/">previous posts</a> for information on inbound rewrite rules.</p>
<h2 id="what-are-cookies">What are cookies?</h2>
<p>Unfornately, in this sense they are not a snack. They are, usually, small bits of information continually transferred between the browser and the server in order to do things like session tracking &amp; identification, or maintain informantion pertainent to your browsing session. If not secured in the right way, you can expose details of your browsing session unknowingly. First up, we can make the cookies <code>httpOnly</code>.</p>
<h2 id="what-are-httponly-cookies">What are httpOnly cookies?</h2>
<p>By adding the modifier to the cookie, we prevent any scripts running from accessing the cookie. The biggest benefit here is protection against Cross-Site Scripting, or XSS. Unless you have very specific requirements for cookies, this flag should always be enabled.</p>
<p><em>For more information, checkout <a href="https://scotthelme.co.uk/tough-cookies/">Scott Helme's incredible post</a> on getting tougher cookies.</em></p>
<h2 id="how-can-we-ensure-our-cookies-are-httponly-with-url-rewrite">How can we ensure our cookies are httpOnly with URL Rewrite</h2>
<p>When a server indicates that it wants to set a cookie, it does so by sending the <code>Set-Cookie</code> HTTP header along with the response. There are a few modifiers that this can have to make them more secure in compliant browsers (eg: Chrome, Firefox, Edge, Safari): <code>httpOnly</code>, <code>secure</code> and <code>sameSite=(lax|strict)</code>.</p>
<p>This rewrite snippet requires two portions: the rule and a set of precondtions.</p>
<pre><code class="language-xml">&lt;rewrite&gt;
    &lt;outboundRules&gt;
        &lt;rule name=&quot;Ensure httpOnly Cookies&quot; preCondition=&quot;Missing httpOnly cookie&quot;&gt;
            &lt;match serverVariable=&quot;RESPONSE_Set_Cookie&quot; pattern=&quot;.*&quot; negate=&quot;false&quot; /&gt;
            &lt;action type=&quot;Rewrite&quot; value=&quot;{R:0}; HttpOnly&quot; /&gt;
        &lt;/rule&gt;
        &lt;preConditions&gt;
            &lt;preCondition name=&quot;Missing httpOnly cookie&quot;&gt;
                &lt;!-- Don't remove the first line! --&gt;
                &lt;add input=&quot;{RESPONSE_Set_Cookie}&quot; pattern=&quot;.&quot; /&gt;
                &lt;add input=&quot;{RESPONSE_Set_Cookie}&quot; pattern=&quot;; HttpOnly&quot; negate=&quot;true&quot; /&gt;
            &lt;/preCondition&gt;
        &lt;/preconditions&gt;
    &lt;/outboundRules&gt;
&lt;/rewrite&gt;
</code></pre>
<p>Within our rule, we are defining the name of the rule which can be viewed inside of <code>inetmgr (IIS Manager)</code>. In previous posts we have added the attribute to stop processing, but here we want to continue processing rewrite rules because we may want to do additional work to the response. Next, we match the server varible for a <code>Set-Cookie</code> HTTP header (<code>RESPONSE_Set_Cookie</code>) and ensure that it's present for us to continue. For our action, we rewrite the <code>Set-Cookie</code> header to be the original value, with the <code>HttpOnly</code> modifier appended.</p>
<p>Within the precondition, which is matched by name to the <code>preCondition</code> attribute in the rule, we do two things:</p>
<ul>
<li>(<em>I think, see below</em>) Make sure that the <code>Set-Cookie</code> header has been set (via the server variable <code>{RESPONSE_Set_Cookie}</code>);</li>
<li>Make sure that we do not already have the <code>HttpOnly</code> modifier set</li>
</ul>
<p>For an unknown reason, probably due to a knowledge gap, the first line is required. I have made a guess as to what this could be, but I am unsure. Strange things happen in the dev tools in Chrome if that first line is not there.</p>
<p><em>It is worth noting that a precondition is not limited to a single rule, it can be re-used. There is probably scope for making this rule smaller, if there is i'll edit the post to reflect the smaller rule.</em></p>
<p>That's it. If you check your debug tool of choice after implementing this, you should see that all cookies are now sent with the <code>HttpOnly</code> modifier.</p>
<h2 id="other-posts-in-this-series">Other Posts In This Series</h2>
<ol>
<li><a href="/article/2017/06/up-and-running-with-url-rewrite---going-from-http-to-https/">Up and running with URL Rewrite - going from HTTP to HTTPS</a></li>
<li><a href="/article/2017/06/canonical-host-urls-with-url-rewrite/">Canonical host urls with URL Rewrite</a></li>
<li><a href="/article/2017/06/removing-trailing-slashes-with-url-rewrite/">Removing trailing slashes with URL Rewrite</a></li>
<li><a href="/article/2017/06/ensuring-httponly-cookies-with-url-rewrite/">Ensuring httpOnly cookies with URL Rewrite</a> <em>(This Post)</em></li>
<li><a href="/article/2017/06/ensuring-secure-cookies-with-url-rewrite/">Ensuring secure cookies with URL Rewrite</a></li>
<li><a href="/article/2017/06/ensuring-samesite-cookies-with-url-rewrite/">Ensuring samesite cookies with URL Rewrite</a></li>
</ol></section>
    <footer class="article-footer">
        <hr /></footer>
</article>
    </section>
    <footer id="pageFooter" class="pageWrap">
    <p>&copy; 2020 <span itemprop="author">Stuart Blackler</span>. Last Updated: <time itemprop="datecreated" class="article-header-time" pubdate="pubdate" datetime="2017-06-06T15:01:04">2017-06-06 15:01:04 &#43;0100 BST</time>. <a id="pageFooter-scroll-link" href="#">Scroll To Top</a>.</p>
</footer>
</section>
<script src="/js/site-54e01995.js" defer></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-88036425-1', 'auto');
  ga('send', 'pageview');
</script>


<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>