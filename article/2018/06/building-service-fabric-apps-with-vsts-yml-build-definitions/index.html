<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Stuart Blackler"><meta name=description content="In my previous article, we setup a standarised build using the new YML build definitions within VSTS, using the .Net CLI tooling. In this article, we will use the same setup as our base, but we will build and publish a service fabric application.
Our sample build file has the following steps:
 Clean Sources Install the Dotnet CLI Restore Packages Build Projects Test Projects Publish the Web App Publish Build Artifacts Tag VSTS Build  For our service fabric build, we will need the following steps:"><meta name=keywords content=",vsts,dotnetcore,service fabric,devops"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://im5tu.io/article/2018/06/building-service-fabric-apps-with-vsts-yml-build-definitions/><title>Building Service Fabric Apps With VSTS YML Build Definitions :: Stuart Blackler's Blog</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.393856bf2c430bb6c01d7af07c6fe966e7cce8073435cfbbc46e590bab7405ef.css><meta itemprop=name content="Building Service Fabric Apps With VSTS YML Build Definitions"><meta itemprop=description content="Publish an Service Fabric application using a VSTS YML build definition."><meta itemprop=datePublished content="2018-06-30T19:40:00+01:00"><meta itemprop=dateModified content="2018-06-30T19:40:00+01:00"><meta itemprop=wordCount content="852"><meta itemprop=keywords content="vsts,dotnetcore,service fabric,devops,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building Service Fabric Apps With VSTS YML Build Definitions"><meta name=twitter:description content="Publish an Service Fabric application using a VSTS YML build definition."><meta property="og:title" content="Building Service Fabric Apps With VSTS YML Build Definitions"><meta property="og:description" content="Publish an Service Fabric application using a VSTS YML build definition."><meta property="og:type" content="article"><meta property="og:url" content="https://im5tu.io/article/2018/06/building-service-fabric-apps-with-vsts-yml-build-definitions/"><meta property="article:published_time" content="2018-06-30T19:40:00+01:00"><meta property="article:modified_time" content="2018-06-30T19:40:00+01:00"><meta property="article:section" content="development"><meta property="article:published_time" content="2018-06-30 19:40:00 +0100 BST"><link rel=alternate type=application/rss+xml href=https://im5tu.io/article/2018/06/building-service-fabric-apps-with-vsts-yml-build-definitions/index.xml title="Stuart Blackler's Blog"><meta property="og:image" content="https://im5tu.io/img/profile.jpg"><meta property="og:site_name" content="Stuart Blackler's Blog"><link rel=alternate type=application/rss+xml href=/index.xml title="Stuart Blackler's Blog"><link rel=preconnect href=https://api.github.com><link rel=preconnect href=https://partner.googleadservices.com><link rel=preconnect href=https://tpc.googlesyndication.com><link rel=preconnect href=https://www.googletagservices.com><link rel=preconnect href=https://googleads.g.doubleclick.net><link rel=preconnect href=https://pagead2.googlesyndication.com><link rel=preload href=/fonts/Inter-UI-Bold.woff2><link rel=preload href=/fonts/Inter-UI-Regular.woff2><style>.post{max-width:1200px}.header__inner{width:100%;max-width:1160px}.copy-code-button{float:right;display:block;padding:8px 12px;font-size:.9em;background-color:#e2e2e2;border-left:1px solid #e2e2e2;border-bottom:1px solid #e2e2e2;border-radius:0;border-bottom-left-radius:10px;transition:all 250ms ease;margin:-18px;opacity:0}.copy-code-button:hover{cursor:pointer;opacity:.7;border-style:solid}.copy-code-button:focus{background-color:#e2e2e2;outline:0;border-style:solid}.copy-code-button:active{background-color:#e2e2e2;opacity:.5;border-style:solid}pre:hover .copy-code-button{opacity:1}.copy-code-button~pre{position:relative}table{width:100%;border-collapse:collapse}table th{background-color:#cecece;color:#222}table tr{margin:0;padding:0}table tr:first-child{border-left:1px solid #acacac;border-top:1px solid #acacac;border-right:1px solid #acacac}table tr td:first-child{border-left:1px solid #acacac}table tr td:last-child{border-right:1px solid #acacac}table td,table th{padding:.5em;border-bottom:1px solid #acacac;margin:0}h2 a:link,h2 a:visited,h3 a:link,h3 a:visited,h4 a:link,h4 a:visited,h5 a:link,h5 a:visited{text-decoration:none}h2 a:hover,h3 a:hover,h4 a:hover,h5 a:hover{text-decoration:underline}@media print{.copy-code-button{display:none}}@media(prefers-color-scheme:dark){.copy-code-button{background-color:#969696;color:#323232}}</style><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-88036425-1','auto');ga('send','pageview');</script><script data-ad-client=ca-pub-8597760177900459 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>im5tu.io</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://im5tu.io/article/>Articles</a></li><li><a href=https://im5tu.io/article/index.xml>RSS Feed</a></li><li><a href=https://bit.ly/im5tu-tw>Twitter</a></li><li><a href=https://bit.ly/im5tu-yt>YouTube</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 minutes</p></div><article><h1 class=post-title><a href=https://im5tu.io/article/2018/06/building-service-fabric-apps-with-vsts-yml-build-definitions/>Building Service Fabric Apps With VSTS YML Build Definitions</a></h1><div class=post-content><p>In my <a href=/article/2018/06/automated-builds-in-vsts-with-yml-build-definitions/>previous article</a>, we setup a standarised build using the new YML build definitions within VSTS, using the .Net CLI tooling. In this article, we will use the same setup as our base, but we will build and publish a service fabric application.</p><p>Our <a href=/article/2018/06/automated-builds-in-vsts-with-yml-build-definitions/>sample build file</a> has the following steps:</p><ol><li>Clean Sources</li><li>Install the Dotnet CLI</li><li>Restore Packages</li><li>Build Projects</li><li>Test Projects</li><li>Publish the Web App</li><li>Publish Build Artifacts</li><li>Tag VSTS Build</li></ol><p>For our service fabric build, we will need the following steps:</p><ol><li>Clean Sources</li><li>Install the Dotnet CLI</li><li>Restore Packages - csproj</li><li><em><em>Restore Packages - sfproj (</em> New)</em>*</li><li>Build Projects</li><li>Test Projects</li><li><em><em>Publish the Service Fabric App (</em> New)</em>*</li><li><em><em>Update the Service Fabric App Version (</em> New)</em>*</li><li><em><em>Copy Publish Profiles (</em> New)</em>*</li><li>Publish Build Artifacts</li><li>Tag VSTS Build</li></ol><p>For the sake of brevity, I am going to only talk about the new steps in the sequence and the reasoning behind their existance but i&rsquo;ll include a full sample file at the end of the post.</p><h2 id=restore-packages-sfproj>Restore Packages (SFPROJ)</h2><p>At first, this step may seem a little strange. Currently, the service fabric tooling does not support the dotnet CLI properly, though it&rsquo;s getting better. The major hurdle is the restoring of the msbuild package that contains the targets - this does not seem to restore properly with the CLI, so I use an additional step using the old nuget commands:</p><pre><code class=language-yml>- task: NuGetCommand@2
  displayName: Restore Packages (SF Projects)
  inputs:
    restoreSolution: $(packageProjects)
    restoreDirectory: '..\..\packages'
    feedsToUse: config
    nugetConfigPath: nuget.config
    noCache: true
    verbosityRestore: Normal
</code></pre><p>Here, <code>$(packageProjects)</code> is defined as <code>**/*.sfproj</code> allowing for multiple service fabric applications in a single solution. The only real difference between this step and the <code>dotnet restore</code> step from the previous article is the fact that we restore to the solution level packages folder instead of <code>dotnet restore</code>'s default location. This is because the targets in the sfproj are looking in this directory. Adjust <code>restoreDirectory</code> according to your own folder structure - I place all the sources under an <code>/src</code> folder for reference.</p><h2 id=publishing-the-service-fabric-app>Publishing the Service Fabric App</h2><p>When it comes around to publishing the application(s), I usually create two versions, one in a debug build and one in release. Both are then published to the artifacts. The debug build is useful for downloading by other developers for use on their local machines and the release build is what is used for deployments. If you wish to mirror this, duplicate the step and replace Release with Debug.</p><pre><code class=language-yml>- task: DotNetCoreCLI@2
  displayName: Package Projects (Publish - Release)
  inputs:
    projects: $(packageProjects)
    packDirectory: '$(Build.ArtifactStagingDirectory)\\drop\\release'
    arguments: '-c Release /p:Platform=x64 /p:Version=$(Build.BuildNumber) /t:Package /p:PackageLocation=$(Build.ArtifactStagingDirectory)\drop\release\applicationpackage'
</code></pre><p><em><strong>Note</strong></em>: <em>Sorry about the formatting, see the full file at the end of the article for the proper formatting.</em></p><p>In this step, we package directly to the artifact staging directory to make publishing to the build artifacts a lot easier later in the process. All of the output is placed inside of the <code>drop</code> folder as a way of differentiating between this artifact and others. Under the <code>drop</code> folder, we split based on the configuration type: Debug/Release. Both the debug and the release folder mirror the same folder structure which is an <code>applicationpackage</code> folder, containing the packaged code and the <code>projectartifacts</code> folder which will contain the publish profiles. So the full folder structure appears like:</p><pre><code class=language-yml>/drop
    /debug
        /applicationpackage
        /projectartifacts
    /release
        /applicationpackage
        /projectartifacts
</code></pre><p>The only other element that I wish to point out is that service fabric applications have to be built as the <code>x64</code> platform.</p><h2 id=update-the-service-fabric-app-version>Update the Service Fabric App Version</h2><p>I am currently unaware of the correct msbuild switch to set the version number of the service fabric application, so I use a built in step to change the manifest numbers to match the assembly numbers and ensure a rolling upgrade is possible on the service fabric cluster.</p><pre><code class=language-yml># Update the service fabric build numbers
- task: ServiceFabricUpdateManifests@2
  displayName: Update Service Fabric Version (Release)
  inputs:
    applicationPackagePath: '$(Build.ArtifactStagingDirectory)\\drop\\release\\applicationpackage'
    versionSuffix: '$(Build.BuildNumber)'
    versionBehavior: Replace
</code></pre><p>The <code>versionBehavior</code> parameter has two modes: Append/Replace. Since I always use the build number, which is always a semver version, I use the replacement mode. We look inside of the <code>applicationpackage</code> folder to find the manifest file, which is the location we previously published the application to.</p><h2 id=copying-publish-profiles>Copying Publish Profiles</h2><p>In order to publish the service fabric application from the release area in VSTS, we need to copy the publish profiles that are defined with the project (unless you want to re-create them in the release pipeline, everytime!).</p><pre><code class=language-yml>- task: CopyFiles@2
  displayName: Copy XML Files To Artifacts (Release)
  inputs:
    SourceFolder: 'src\'
    Contents: |
     **\*.ServiceFabric\PublishProfiles\*.xml
     **\*.ServiceFabric\ApplicationParameters\*.xml
    TargetFolder: '$(Build.ArtifactStagingDirectory)\drop\release\projectartifacts\'
    CleanTargetFolder: true
</code></pre><p>As mentioned previously, I keep the sourcecode under an <code>src</code> folder in the repository. Inside of that folder, we need to search for any xml files in the <code>PublishProfiles</code> and <code>ApplicationParameters</code> folders and place them in the <code>projectartifacts</code> folder as described previously. The only convention here is that my service fabric applications end in <code>.ServiceFabric</code> so you may need to adjust this for your own build scripts.</p><p>If you put all the pieces together, you should have a working service fabric build pipeline, along the lines of the following sample:</p></div></article><hr><div><p><i>If you haven't already, subscribe to my new <a href=https://bit.ly/im5tu-yt target=_blank>YouTube Channel</a>, Code With Stu. Here you'll find different tip, tricks and tutorials using some of the latest technologies, in bitesize chunks.</i></p></div><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://im5tu.io/tags/vsts>vsts</a></span><span class=tag><a href=https://im5tu.io/tags/dotnetcore>dotnetcore</a></span><span class=tag><a href=https://im5tu.io/tags/service-fabric>service fabric</a></span><span class=tag><a href=https://im5tu.io/tags/devops>devops</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>852 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2018-06-30 19:40 +0100</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://im5tu.io/article/2018/07/utf8json-media-formatters-for-asp.net-core/><span class=button__icon>←</span>
<span class=button__text>Utf8Json Media Formatters for ASP.Net Core</span></a></span>
<span class="button next"><a href=https://im5tu.io/article/2018/06/automated-builds-in-vsts-with-yml-build-definitions/><span class=button__text>Automated Builds in VSTS with YML Build Definitions</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=Im5tu/im5tu-hugo issue-term=url label=Comment theme=photon-dark crossorigin=anonymous async></script></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://im5tu.io/>Stuart Blackler</a></span>
<span><a href=https://im5tu.io/article/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Theme made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=/bundle.min.dc716e9092c9820b77f96da294d0120aeeb189b5bcea9752309ebea27fd53bbe6b13cffb2aca8ecf32525647ceb7001f76091de4199ac5a3caa432c070247f5b.js integrity="sha512-3HFukJLJggt3+W2ilNASCu6xibW86pdSMJ6+on/VO75rE8/7KsqOzzJSVkfOtwAfdgkd5BmaxaPKpDLAcCR/Ww=="></script><script src=/js/site-20c12b24.js defer></script></body></html>