<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Stuart Blackler"><meta name=description content="In this article, we will learn how to use a custom dockerfile as the bases for a customised Azure DevOps build agent. There are many reasons why you might want to do this, including running custom tooling that takes a while to setup or tooling that isn&amp;rsquo;t supported yet."><meta name=keywords content=",devops,vsts,azure"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://im5tu.io/article/2018/12/building-a-custom-build-agent-image-with-docker-and-azure-devops-pipelines/><title>Building a custom build agent image with Docker and Azure DevOps pipelines :: Stuart Blackler's Blog</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.dede02da9537a98158079c023e83573e18127834838ef08172acce888341a797.css><meta itemprop=name content="Building a custom build agent image with Docker and Azure DevOps pipelines"><meta itemprop=description content="Learn how to use a custom dockerfile as the bases for a customised Azure DevOps build agent."><meta itemprop=datePublished content="2018-12-24T14:00:00+00:00"><meta itemprop=dateModified content="2018-12-24T14:00:00+00:00"><meta itemprop=wordCount content="602"><meta itemprop=keywords content="devops,vsts,azure,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building a custom build agent image with Docker and Azure DevOps pipelines"><meta name=twitter:description content="Learn how to use a custom dockerfile as the bases for a customised Azure DevOps build agent."><meta property="og:title" content="Building a custom build agent image with Docker and Azure DevOps pipelines"><meta property="og:description" content="Learn how to use a custom dockerfile as the bases for a customised Azure DevOps build agent."><meta property="og:type" content="article"><meta property="og:url" content="https://im5tu.io/article/2018/12/building-a-custom-build-agent-image-with-docker-and-azure-devops-pipelines/"><meta property="article:published_time" content="2018-12-24T14:00:00+00:00"><meta property="article:modified_time" content="2018-12-24T14:00:00+00:00"><meta property="article:section" content="Development"><meta property="article:published_time" content="2018-12-24 14:00:00 +0000 GMT"><link rel=alternate type=application/rss+xml href=https://im5tu.io/article/2018/12/building-a-custom-build-agent-image-with-docker-and-azure-devops-pipelines/index.xml title="Stuart Blackler's Blog"><meta property="og:image" content="https://im5tu.io/img/profile.jpg"><meta property="og:site_name" content="Stuart Blackler's Blog"><link rel=alternate type=application/rss+xml href=/index.xml title="Stuart Blackler's Blog"><style>.post{max-width:1200px}.header__inner{width:100%;max-width:1160px}.copy-code-button{float:right;display:block;padding:8px 12px;font-size:.9em;background-color:#e2e2e2;border-left:1px solid #e2e2e2;border-bottom:1px solid #e2e2e2;border-radius:0;border-bottom-left-radius:10px;-webkit-transition:all 250ms ease;transition:all 250ms ease;margin:-18px;opacity:0}.copy-code-button:hover{cursor:pointer;opacity:.7;border-style:solid}.copy-code-button:focus{background-color:#e2e2e2;outline:0;border-style:solid}.copy-code-button:active{background-color:#e2e2e2;opacity:.5;border-style:solid}pre:hover .copy-code-button{opacity:1}.copy-code-button~pre{position:relative}@media print{.copy-code-button{display:none}}@media(prefers-color-scheme:dark){.copy-code-button{background-color:#969696;color:#323232}}</style><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-88036425-1','auto');ga('send','pageview');</script><script data-ad-client=ca-pub-8597760177900459 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=https://im5tu.io/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>im5tu.io</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://im5tu.io/article/>Articles</a></li><li><a href=https://im5tu.io/index.xml>RSS Feed</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 minutes</p></div><article><h1 class=post-title><a href=https://im5tu.io/article/2018/12/building-a-custom-build-agent-image-with-docker-and-azure-devops-pipelines/>Building a custom build agent image with Docker and Azure DevOps pipelines</a></h1><div class=post-content><p>In this article, we will learn how to use a custom dockerfile as the bases for a customised Azure DevOps build agent. There are many reasons why you might want to do this, including running custom tooling that takes a while to setup or tooling that isn&rsquo;t supported yet.</p><h3 id=tldr>TL;DR:</h3><p>You need to this <code>Dockerfile</code> snippet:</p><pre><code class=language-dockerfile>FROM microsoft/vsts-agent:ubuntu-16.04

# Install your stuff here

CMD /bin/sh
</code></pre><p>And this <code>azure-pipelines.yml</code> snippet:</p><pre><code class=language-yml>resources:
    containers:
    - container: octodns
        image: im5tu/octodns:latest

container: octodns

steps:
# Your steps go here
</code></pre><h2 id=starting-with-a-dockerfile>Starting with a Dockerfile</h2><p>In order to use a custom image as part of the build process, we need to start off with a shell of a docker file. Microsoft have graciously given us a series of base images to start from. You can find them <a href=https://hub.docker.com/r/microsoft/vsts-agent>here</a>. For this article, I will use the <code>ubuntu-16.04</code> release.</p><p>In the repository of your choice, create a file called <code>Dockerfile</code>. Note that the name is case sensitive because of the docker builds that we will do later on. I found this out the hard way, and if you&rsquo;ve made the mistake too - run the following command to reset it within git: <code>git mv -f dockerfile Dockerfile</code></p><p>At the top of the Dockerfile, start off with the following:</p><pre><code class=language-dockerfile>FROM microsoft/vsts-agent:ubuntu-16.04
</code></pre><p>During the build, this will instruct docker to pull the image called <code>vsts-agent</code> tagged with <code>ubuntu-16.04</code> from the user <code>microsoft</code>.</p><p>Then at the bottom of the Dockerfile, place the following line:</p><pre><code class=language-dockerfile>CMD /bin/sh
</code></pre><p>This instructs the built image to leave a command prompt as the entrypoint so that we can run the rest of our scripts.</p><h3 id=a-note-on-the-base-image-choice>A note on the base image choice</h3><p>I did initially try experimenting with an Alpine base image, but there seems to be some requirements around what the image contains. Unfortunately, I don&rsquo;t know what the requirements are/I haven&rsquo;t gone to figure them out. If you want to, feel free to browse the dockerfiles <a href=https://github.com/Microsoft/vsts-agent-docker/>here</a> to see what&rsquo;s required, but I would just stick with the hosted images supplied by Microsoft as your base.</p><h2 id=building-with-dockerhub>Building with DockerHub</h2><p>If your repository is hosted on either Bitbucket or Github, you can get your docker image built and hosted for free by Docker. In order to do this, you need to link either your Github or Bitbucket account from the following page: <code>https://cloud.docker.com/u/&lt;your user id>/settings</code></p><p>Once that is complete, if you navigate to the page <a href=https://cloud.docker.com/repository/create>https://cloud.docker.com/repository/create</a> you should see the following:</p><p><img src=/img/custom-docker-agent/Create-Repository.png alt="Docker - Create Repository Screen"></p><p>From here we can create a link to our hosted repository and setup a build that is associated with the repository.</p><h3 id=existing-repositories>Existing repositories</h3><p>If you need to edit an existing repository or build, you can do that from the following page: <code>https://cloud.docker.com/repository/docker/&lt;user id>/&lt;repo name>/builds</code></p><p><img src=/img/custom-docker-agent/Build-Page.png alt="Docker - Builds Screen"></p><h2 id=using-the-dockerfile-in-a-azure-devops-pipeline>Using the Dockerfile in a Azure DevOps pipeline</h2><p>Once the build agent has successfully built, we can start to create our <code>azure-pipelines.yml</code> file around the new custom container. Above the <code>steps</code> section of the file, add the following snippet:</p><pre><code class=language-yml>resources:
    containers:
    - container: &lt;name&gt;
        image: &lt;user id&gt;/&lt;repo name&gt;:&lt;tag&gt;

container: &lt;name&gt;
</code></pre><p>Which, when populated looks like the following:</p><pre><code class=language-yml>resources:
    containers:
    - container: octodns
        image: im5tu/octodns:latest

container: octodns
</code></pre><p>That&rsquo;s it, you should now have a functioning customised Azure DevOps build agent. After that you can play with any additional steps, triggers, variables or what ever your heart desires. Here&rsquo;s what it looks like when it&rsquo;s running instead of Azure DevOps (with the container initialization step highlighted):</p><p><img src=/img/custom-docker-agent/Running-Agent.png alt="Azure DevOps - Running Custom Containers"></p><p>To view the Dockerfile that I am currently using as a custom agent, <a href=https://github.com/Im5tu/octodns-docker/blob/master/Dockerfile>go here</a>.</p><p>To view the full usage of the docker file that I am using, <a href=https://github.com/Im5tu/dns/blob/master/azure-pipelines.yml>go here</a>.</p><h3 id=further-reading>Further Reading</h3><ul><li><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/container-phases?view=vsts&tabs=yaml">Container Jobs</a></li><li><a href=https://docs.docker.com/docker-hub/builds/>Docker Automated Builds</a></li><li><a href=https://docs.docker.com/develop/develop-images/multistage-build/>Docker Multi-Stage Builds</a></li></ul></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://im5tu.io/tags/devops>devops</a></span><span class=tag><a href=https://im5tu.io/tags/vsts>vsts</a></span><span class=tag><a href=https://im5tu.io/tags/azure>azure</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>602 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2018-12-24 14:00 +0000</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://im5tu.io/article/2018/12/quick-tip-accessing-a-azure-devops-secret-from-within-a-scripted-step/><span class=button__icon>←</span>
<span class=button__text>Quick Tip: Accessing a Azure DevOps secret from within a scripted step</span></a></span>
<span class="button next"><a href=https://im5tu.io/article/2018/07/utf8json-media-formatters-for-asp.net-core/><span class=button__text>Utf8Json Media Formatters for ASP.Net Core</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=Im5tu/im5tu-hugo issue-term=url label=Comment theme=photon-dark crossorigin=anonymous async></script></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2020</span>
<span><a href=https://im5tu.io/>Stuart Blackler</a></span>
<span><a href=https://im5tu.io/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Theme made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=/bundle.min.dc716e9092c9820b77f96da294d0120aeeb189b5bcea9752309ebea27fd53bbe6b13cffb2aca8ecf32525647ceb7001f76091de4199ac5a3caa432c070247f5b.js integrity="sha512-3HFukJLJggt3+W2ilNASCu6xibW86pdSMJ6+on/VO75rE8/7KsqOzzJSVkfOtwAfdgkd5BmaxaPKpDLAcCR/Ww=="></script><script src=/js/site-c4a43965.js defer></script></body></html>