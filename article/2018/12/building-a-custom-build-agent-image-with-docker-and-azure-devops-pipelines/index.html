<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Building a custom build agent image with Docker and Azure DevOps pipelines - Stuart Blackler&#39;s Blog</title>
    <link rel="canonical" href="https://im5tu.io/article/2018/12/building-a-custom-build-agent-image-with-docker-and-azure-devops-pipelines/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="description" content="Learn how to use a custom dockerfile as the bases for a customised Azure DevOps build agent.">
    
    
    <meta property="og:title" content="Building a custom build agent image with Docker and Azure DevOps pipelines - Stuart Blackler&#39;s Blog" />
<meta property="og:type" content="website" />

<meta property="og:description" content="Learn how to use a custom dockerfile as the bases for a customised Azure DevOps build agent.">

<meta property="og:url" content="https://im5tu.io/article/2018/12/building-a-custom-build-agent-image-with-docker-and-azure-devops-pipelines/" />
<meta property="og:image" content="https://im5tu.io/img/profile.jpg" />
<meta property="og:site_name" content="Stuart Blackler&#39;s Blog" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@im5tu" />

<style>html, body {
  height: 100%;
  color: #303030;
  font-family: "Noto Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-display: auto;
}

h1, h2, h3, h4, h5, h6 {
  font-family: "Comfortaa", "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-display: auto;
}

p {
  margin: 1.5em 0;
}

blockquote {
  border-left: 5px solid #454545;
  background-color: #fafafa;
  padding: 0.5em 1.5em;
}
blockquote, blockquote p {
  color: #494949;
}
blockquote ~ blockquote {
  margin-top: 0;
  margin-bottom: 0;
}

.pageContainer {
  text-align: justify;
}

.pageWrap {
  margin: 0 auto;
  max-width: 1400px;
}
@media screen and (min-width: 320px) {
  .pageWrap {
    width: 97%;
  }
}
@media screen and (min-width: 740px) {
  .pageWrap {
    width: 90%;
  }
}
@media screen and (min-width: 980px) {
  .pageWrap {
    width: 80%;
  }
}
.pageWrap:after {
  content: "";
  display: table;
  clear: both;
}

a {
  font-family: "Comfortaa", "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-display: auto;
}
a:link, a:visited {
  color: #149fd1;
}
a:link {
  text-decoration: none;
}
a:hover {
  color: #2db9eb;
  text-decoration: underline;
}

#pageHeader-about {
  border-bottom: 1px solid #eaeaea;
}

#pageHeader-about-title a {
  font-size: 1.2em;
}
#pageHeader-about-title a:link, #pageHeader-about-title a:visited {
  color: #232323;
}
#pageHeader-about-title a:first-child {
  font-size: 1.1em;
  color: #149fd1;
  text-transform: none;
}

.article-list a {
  color: #0a0a0a;
}
.article-list a:hover {
  color: #2db9eb;
  text-decoration: underline;
}

.article-content p code, .article-content li code {
  color: #149fd1;
  background-color: rgba(27, 31, 35, 0.05);
}
.article-content p code:hover, .article-content li code:hover {
  opacity: 0.5;
}

.article img {
  max-width: 100%;
}

.copy-code-button {
  float: right;
  display: block;
  padding: 3px 8px;
  font-size: 0.8em;
  background-color: #e2e2e2;
  border: 1px solid #e2e2e2;
  border-radius: 0 0 10px 10px;
  -webkit-transition: all 250ms ease;
  transition: all 250ms ease;
  opacity: 0;
}
.copy-code-button:hover {
  cursor: pointer;
  opacity: 0.7;
  border-style: solid;
}
.copy-code-button:focus {
  background-color: #e2e2e2;
  outline: 0;
  border-style: solid;
}
.copy-code-button:active {
  background-color: #e2e2e2;
  opacity: 0.5;
  border-style: solid;
}

pre:hover .copy-code-button {
  opacity: 1;
}

.copy-code-button ~ pre {
  position: relative;
}

@media print {
  .copy-code-button {
    display: none;
  }
}</style>
<link href="https://fonts.googleapis.com/css?family=Comfortaa|Noto+Sans&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/tomorrow.min.css" rel="stylesheet"><link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Stuart Blackler&#39;s Blog" /></head>
<body>
<section class="pageContainer">
    <header id="pageHeader">
    <section id="pageHeader-about" class="pageWrap" itemscope itemtype="http://schema.org/person">
        <section id="pageHeader-about-title">
            <h1 itemprop="name"><a href="/" title="Stuart Blackler">@im5tu</a> / <a href="https://im5tu.io/article/2018/12/building-a-custom-build-agent-image-with-docker-and-azure-devops-pipelines/">Building a custom build agent image with Docker and Azure DevOps pipelines</a></h1>
        </section>
    </section>
</header>
    <section class="pageContainer-content pageWrap">
        <article class="article" itemscope itemtype="http://schema.org/blog">
    <section class="article-content" itemprop="text"><p>In this article, we will learn how to use a custom dockerfile as the bases for a customised Azure DevOps build agent. There are many reasons why you might want to do this, including running custom tooling that takes a while to setup or tooling that isn't supported yet.</p>
<h3 id="tldr">TL;DR:</h3>
<p>You need to this <code>Dockerfile</code> snippet:</p>
<pre><code class="language-dockerfile">FROM microsoft/vsts-agent:ubuntu-16.04

# Install your stuff here

CMD /bin/sh
</code></pre>
<p>And this <code>azure-pipelines.yml</code> snippet:</p>
<pre><code class="language-yml">resources:
    containers:
    - container: octodns
        image: im5tu/octodns:latest

container: octodns

steps:
# Your steps go here
</code></pre>
<h2 id="starting-with-a-dockerfile">Starting with a Dockerfile</h2>
<p>In order to use a custom image as part of the build process, we need to start off with a shell of a docker file. Microsoft have graciously given us a series of base images to start from. You can find them <a href="https://hub.docker.com/r/microsoft/vsts-agent">here</a>. For this article, I will use the <code>ubuntu-16.04</code> release.</p>
<p>In the repository of your choice, create a file called <code>Dockerfile</code>. Note that the name is case sensitive because of the docker builds that we will do later on. I found this out the hard way, and if you've made the mistake too - run the following command to reset it within git: <code>git mv -f dockerfile Dockerfile</code></p>
<p>At the top of the Dockerfile, start off with the following:</p>
<pre><code class="language-dockerfile">FROM microsoft/vsts-agent:ubuntu-16.04
</code></pre>
<p>During the build, this will instruct docker to pull the image called <code>vsts-agent</code> tagged with <code>ubuntu-16.04</code> from the user <code>microsoft</code>.</p>
<p>Then at the bottom of the Dockerfile, place the following line:</p>
<pre><code class="language-dockerfile">CMD /bin/sh
</code></pre>
<p>This instructs the built image to leave a command prompt as the entrypoint so that we can run the rest of our scripts.</p>
<h3 id="a-note-on-the-base-image-choice">A note on the base image choice</h3>
<p>I did initially try experimenting with an Alpine base image, but there seems to be some requirements around what the image contains. Unfortunately, I don't know what the requirements are/I haven't gone to figure them out. If you want to, feel free to browse the dockerfiles <a href="https://github.com/Microsoft/vsts-agent-docker/">here</a> to see what's required, but I would just stick with the hosted images supplied by Microsoft as your base.</p>
<h2 id="building-with-dockerhub">Building with DockerHub</h2>
<p>If your repository is hosted on either Bitbucket or Github, you can get your docker image built and hosted for free by Docker. In order to do this, you need to link either your Github or Bitbucket account from the following page: <code>https://cloud.docker.com/u/&lt;your user id&gt;/settings</code></p>
<p>Once that is complete, if you navigate to the page <a href="https://cloud.docker.com/repository/create">https://cloud.docker.com/repository/create</a> you should see the following:</p>
<p><img src="/img/custom-docker-agent/Create-Repository.png" alt="Docker - Create Repository Screen"></p>
<p>From here we can create a link to our hosted repository and setup a build that is associated with the repository.</p>
<h3 id="existing-repositories">Existing repositories</h3>
<p>If you need to edit an existing repository or build, you can do that from the following page: <code>https://cloud.docker.com/repository/docker/&lt;user id&gt;/&lt;repo name&gt;/builds</code></p>
<p><img src="/img/custom-docker-agent/Build-Page.png" alt="Docker - Builds Screen"></p>
<h2 id="using-the-dockerfile-in-a-azure-devops-pipeline">Using the Dockerfile in a Azure DevOps pipeline</h2>
<p>Once the build agent has successfully built, we can start to create our <code>azure-pipelines.yml</code> file around the new custom container. Above the <code>steps</code> section of the file, add the following snippet:</p>
<pre><code class="language-yml">resources:
    containers:
    - container: &lt;name&gt;
        image: &lt;user id&gt;/&lt;repo name&gt;:&lt;tag&gt;

container: &lt;name&gt;
</code></pre>
<p>Which, when populated looks like the following:</p>
<pre><code class="language-yml">resources:
    containers:
    - container: octodns
        image: im5tu/octodns:latest

container: octodns
</code></pre>
<p>That's it, you should now have a functioning customised Azure DevOps build agent. After that you can play with any additional steps, triggers, variables or what ever your heart desires. Here's what it looks like when it's running instead of Azure DevOps (with the container initialization step highlighted):</p>
<p><img src="/img/custom-docker-agent/Running-Agent.png" alt="Azure DevOps - Running Custom Containers"></p>
<p>To view the Dockerfile that I am currently using as a custom agent, <a href="https://github.com/Im5tu/octodns-docker/blob/master/Dockerfile">go here</a>.</p>
<p>To view the full usage of the docker file that I am using, <a href="https://github.com/Im5tu/dns/blob/master/azure-pipelines.yml">go here</a>.</p>
<h3 id="further-reading">Further Reading</h3>
<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/container-phases?view=vsts&amp;tabs=yaml">Container Jobs</a></li>
<li><a href="https://docs.docker.com/docker-hub/builds/">Docker Automated Builds</a></li>
<li><a href="https://docs.docker.com/develop/develop-images/multistage-build/">Docker Multi-Stage Builds</a></li>
</ul></section>
    <footer class="article-footer">
        <hr /></footer>
</article>
    </section>
    <footer id="pageFooter" class="pageWrap">
    <p>&copy; 2020 <span itemprop="author">Stuart Blackler</span>. Last Updated: <time itemprop="datecreated" class="article-header-time" pubdate="pubdate" datetime="2018-12-24T14:00:00">2018-12-24 14:00:00 &#43;0000 GMT</time>. <a id="pageFooter-scroll-link" href="#">Scroll To Top</a>.</p>
</footer>
</section>
<script src="/js/site-54e01995.js" defer></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-88036425-1', 'auto');
  ga('send', 'pageview');
</script>


<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>